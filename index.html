<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>CNC Connect Algérie - Leader de la Production Industrielle</title>
    <meta name="description"
        content="Plateforme n°1 de production CNC en Algérie. Upload 3D, devis instantané, 500+ ateliers certifiés, livraison J+3.">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Three.js r128 (stable avec OrbitControls + STLLoader en mode global) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .gradient-primary {
            background: linear-gradient(135deg, #005f9e 0%, #0077c2 100%);
        }

        .gradient-hero {
            background: linear-gradient(135deg, #005f9e 0%, #0095e8 50%, #00b4ff 100%);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }

        .progress-bar {
            transition: width 0.3s ease-in-out;
        }

        #canvas-container {
            touch-action: none;
        }

        .service-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .service-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-indicator {
            position: absolute;
            bottom: 0;
            height: 3px;
            background: #005f9e;
            transition: all 0.3s ease;
        }

        /* Hide scrollbar but keep functionality */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom scrollbar for desktop */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">

    <!-- App Container -->
    <div id="app" class="relative pb-20"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div
                class="w-24 h-24 bg-gradient-primary rounded-3xl flex items-center justify-center mb-4 mx-auto animate-pulse relative overflow-hidden">
                <svg class="w-16 h-16 text-white" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Logo CNC stylisé avec engrenage et précision -->
                    <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2" fill="none" />
                    <path d="M32 12 L38 18 L32 24 L26 18 Z" fill="currentColor" />
                    <path d="M12 32 L18 38 L24 32 L18 26 Z" fill="currentColor" />
                    <path d="M40 32 L46 38 L52 32 L46 26 Z" fill="currentColor" />
                    <path d="M32 40 L38 46 L32 52 L26 46 Z" fill="currentColor" />
                    <circle cx="32" cy="32" r="6" fill="currentColor" />
                    <text x="32" y="36" font-size="8" fill="#005f9e" text-anchor="middle" font-weight="bold"
                        font-family="Inter">CNC</text>
                </svg>
                <div class="absolute inset-0 bg-gradient-to-br from-transparent via-white/10 to-transparent"></div>
            </div>
            <h1 class="text-2xl font-black text-slate-900">CNC CONNECT ALGÉRIE</h1>
            <p class="text-sm text-slate-500 mt-2">Chargement...</p>
        </div>
    </div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        const AppState = {
            currentView: 'CLIENT', // 'CLIENT' | 'FACTORY' | 'ADMIN'
            currentRoute: 'HOME', // 'HOME' | 'QUOTE' | 'SERVICE_DETAIL' | 'PROFILE' | 'NETWORK' | 'TRAINING' | 'PARTS' | 'MAINTENANCE'
            activeData: null,
            isMenuOpen: false,
            isSearchOpen: false,
            orders: [
                { id: 'DZ-2024-001', client: 'Sarl Plast', clientEmail: 'contact@sarlplast.dz', file: 'Pignon à chaîne - Acier C45', status: 'WAITING', date: '2024-11-20', price: 15000, config: { material: 'Acier C45', process: 'Fraisage CNC', quantity: 10 }, assignedWorkshop: null, assignedMachine: null },
                { id: 'DZ-2024-002', client: 'Start-up IOT', clientEmail: 'dev@iotalgeria.com', file: 'Boîtier Électronique - Alu 6061', status: 'MACHINING', date: '2024-11-21', price: 42000, config: { material: 'Aluminium 6061-T6', process: 'Fraisage CNC', quantity: 5 }, assignedWorkshop: 'Atelier Precision CNC Alger', assignedMachine: 'CNC-1 Haas VF2' },
                { id: 'DZ-2024-003', client: 'Agroalim Sud', clientEmail: 'tech@agroalim.dz', file: 'Arbre de transmission - Inox 304', status: 'QC', date: '2024-11-19', price: 89000, config: { material: 'Acier Inoxydable 304L', process: 'Tournage CNC', quantity: 2 }, assignedWorkshop: 'Usine Mécanique Oran', assignedMachine: 'Tour CNC Doosan' },
            ],
            workshops: [
                { id: 'WS-001', name: 'Atelier Precision CNC Alger', city: 'Alger', specialties: ['Fraisage CNC', 'Tournage CNC'], capacity: 85, rating: 4.8, activeOrders: 3 },
                { id: 'WS-002', name: 'Usine Mécanique Oran', city: 'Oran', specialties: ['Fraisage CNC', 'Tôlerie'], capacity: 60, rating: 4.6, activeOrders: 5 },
                { id: 'WS-003', name: 'Tech Industrie Constantine', city: 'Constantine', specialties: ['Impression 3D', 'Fraisage CNC'], capacity: 90, rating: 4.9, activeOrders: 2 },
                { id: 'WS-004', name: 'Mecatronic Annaba', city: 'Annaba', specialties: ['Tournage CNC', 'Moulage Injection'], capacity: 70, rating: 4.7, activeOrders: 4 },
                { id: 'WS-005', name: 'Inox Pro Blida', city: 'Blida', specialties: ['Tôlerie', 'Fraisage CNC'], capacity: 75, rating: 4.5, activeOrders: 3 },
            ],
            supportMessages: [
                { id: 'MSG-001', clientName: 'Ahmed Benali', clientEmail: 'ahmed.b@gmail.com', orderId: 'DZ-2024-001', subject: 'Question sur le délai', message: 'Bonjour, quel est le délai de livraison pour ma commande ?', status: 'unread', date: '2024-11-22 10:30', replies: [] },
                {
                    id: 'MSG-002', clientName: 'Fatima Kaci', clientEmail: 'f.kaci@startup.dz', orderId: 'DZ-2024-002', subject: 'Modification matière', message: 'Est-il possible de changer la matière pour de l\'aluminium 7075 ?', status: 'replied', date: '2024-11-22 09:15', replies: [
                        { sender: 'admin', text: 'Oui c\'est possible, je vais mettre à jour le devis.', timestamp: '2024-11-22 09:45' }
                    ]
                },
                { id: 'MSG-003', clientName: 'Karim Mehdi', clientEmail: 'karim@agroalim.dz', orderId: null, subject: 'Demande de devis personnalisé', message: 'Je souhaite une série de 500 pièces en inox 316L, pouvez-vous me faire un devis ?', status: 'unread', date: '2024-11-22 08:00', replies: [] },
            ],
            expenses: [
                { id: 'EXP-001', description: 'Achat Aluminium 6061-T6 (50kg)', category: 'Matières Premières', amount: 30000, date: '2024-11-20', supplier: 'MetalAlgérie' },
                { id: 'EXP-002', description: 'Set de fraises carbure', category: 'Outils', amount: 25000, date: '2024-11-21', supplier: 'OutillagePro' },
                { id: 'EXP-003', description: 'Électricité atelier (Novembre)', category: 'Charges', amount: 15000, date: '2024-11-22', supplier: 'Sonelgaz' },
            ],
            inventory: [
                { id: 'INV-001', type: 'Matière', name: 'Aluminium 6061-T6', reference: 'AL-6061-PL8', stock: 120, unit: 'kg', minStock: 40, category: 'Matières Premières', supplier: 'MetalAlgérie' },
                { id: 'INV-002', type: 'Matière', name: 'Inox 304L', reference: 'INOX-304-RND40', stock: 80, unit: 'kg', minStock: 30, category: 'Matières Premières', supplier: 'Inox DZ' },
                { id: 'INV-003', type: 'Outil', name: 'Fraises carbure Ø10', reference: 'FR-10-TiAlN', stock: 25, unit: 'pcs', minStock: 10, category: 'Outils', supplier: 'OutillagePro' },
                { id: 'INV-004', type: 'Consommable', name: 'Lubrifiant soluble 20L', reference: 'LUB-20L', stock: 6, unit: 'bidon', minStock: 3, category: 'Consommables', supplier: 'LubriTech' },
            ],
            clients: [
                { id: 'CL-001', company: 'Sarl Plast', contact: 'Amine K.', email: 'contact@sarlplast.dz', phone: '+213 550 123 456', sector: 'Plasturgie', notes: 'Client récurrent, sensible au délai.', totalOrders: 12, totalRevenue: 850000 },
                { id: 'CL-002', company: 'Start-up IOT', contact: 'Nadia B.', email: 'dev@iotalgeria.com', phone: '+213 662 789 101', sector: 'Électronique', notes: 'Petites séries régulières.', totalOrders: 7, totalRevenue: 420000 },
                { id: 'CL-003', company: 'Agroalim Sud', contact: 'Karim M.', email: 'tech@agroalim.dz', phone: '+213 551 333 222', sector: 'Agroalimentaire', notes: 'Projets spéciaux inox.', totalOrders: 5, totalRevenue: 610000 },
            ],
            team: [
                { id: 'EMP-001', name: 'Mohamed Ali', role: 'Programmeur CNC', skills: ['Fraisage 3 axes', 'Fusion 360 CAM'], hourlyRate: 1800, active: true },
                { id: 'EMP-002', name: 'Sara Ben', role: 'Opératrice CNC', skills: ['Tournage CNC', 'Contrôle 3D'], hourlyRate: 1500, active: true },
                { id: 'EMP-003', name: 'Yacine L.', role: 'Responsable Qualité', skills: ['ISO 9001', 'Contrôle dimensionnel'], hourlyRate: 2000, active: true },
            ],
            machines: [
                { id: 'MC-001', name: 'CNC-1 Haas VF2', type: 'Fraisage 3 axes', load: 65, status: 'Disponible' },
                { id: 'MC-002', name: 'CNC-2 DMG Mori 5 axes', type: 'Fraisage 5 axes', load: 80, status: 'Chargée' },
                { id: 'MC-003', name: 'Tour CNC Doosan', type: 'Tournage', load: 55, status: 'Disponible' },
            ],
            nonConformities: [
                { id: 'NC-001', orderId: 'DZ-2024-003', client: 'Agroalim Sud', date: '2024-11-18', type: 'Dimensionnel', severity: 'Moyen', status: 'Ouvert', description: 'Ø alésage hors tolérance de 0.08mm', action: 'Reprise en usinage programmée' },
                { id: 'NC-002', orderId: 'DZ-2024-002', client: 'Start-up IOT', date: '2024-11-15', type: 'Aspect', severity: 'Faible', status: 'Clôturé', description: 'Rayure légère sur face visible', action: 'Polissage & geste commercial' },
            ],
            chatState: {
                isOpen: false,
                messages: [
                    { id: 1, text: "Bonjour ! Je suis votre ingénieur dédié. N'hésitez pas si vous avez des questions sur votre devis.", sender: 'engineer', timestamp: '10:00' }
                ],
                isTyping: false,
                unreadCount: 1
            },
            uploadState: {
                status: 'idle', // 'idle' | 'uploading' | 'analyzing' | 'complete'
                progress: 0,
                fileData: null,
                geoData: null
            },
            dfmState: {
                status: 'idle', // 'idle' | 'analyzing' | 'complete'
                report: null
            },
            config: {
                process: 'Fraisage CNC',
                material: 'Aluminium 6061-T6',
                finish: 'Brut d\'usinage (Standard)',
                tolerance: 'Standard (ISO 2768-m)',
                quantity: 1,
                delivery: 'Standard (J+7)',
                certificates: [],
                instructions: '',
                threadInspection: false
            },
            savedQuotes: [],
            multiFiles: [],
            price: {
                unit: 0,
                total: 0,
                breakdown: {}
            }
        };

        // ==================== DATA ====================
        const SERVICES_DATA = {
            'cnc': {
                id: 'cnc',
                title: 'Usinage CNC',
                subtitle: 'Précision et rapidité pour vos pièces métalliques et plastiques.',
                icon: 'settings',
                description: 'Fraisage 3 & 5 axes, Tournage. Précision +/- 0.05mm.',
                longDescription: 'Notre service d\'usinage CNC offre une précision exceptionnelle pour la production de pièces complexes en métal et en plastique. Que ce soit pour des prototypes unitaires ou des séries de production, nous garantissons des tolérances serrées et une finition de surface impeccable.',
                benefits: ['Précision +/- 0.01mm', 'Fraisage 3, 4 et 5 axes', 'Tournage multi-broches', 'Finitions de surface variées'],
                steps: [
                    { title: 'Importez votre fichier', desc: 'Chargez votre modèle 3D (STEP, IGES, XT) sur notre plateforme sécurisée.', icon: 'upload-cloud' },
                    { title: 'Configurez & Chiffrez', desc: 'Choisissez matière, finition et quantité. Obtenez un prix instantané.', icon: 'settings' },
                    { title: 'Production & Livraison', desc: 'Nous usinons vos pièces et les livrons en J+3 partout en Algérie.', icon: 'truck' }
                ],
                materials: ['Aluminium 6061-T6', 'Acier Inoxydable 304L', 'Acier C45', 'Laiton', 'PEEK', 'Delrin (POM)', 'ABS'],
                gallery: ['bg-slate-300', 'bg-slate-400', 'bg-slate-500']
            },
            '3d-print': {
                id: '3d-print',
                title: 'Impression 3D',
                subtitle: 'Prototypage rapide et production additive industrielle.',
                icon: 'cpu',
                description: 'FDM, SLA pour prototypage rapide en ABS/PLA.',
                longDescription: 'Accélérez votre développement produit grâce à nos technologies additives. Du prototypage rapide en FDM aux pièces finales en SLS ou MJF, nous couvrons tous vos besoins en polymères avec des délais ultra-courts.',
                benefits: ['Délai J+1 disponible', 'Large choix de matériaux', 'Géométries complexes', 'Sans outillage'],
                steps: [
                    { title: 'Upload 3D', desc: 'Glissez votre fichier STL ou OBJ.', icon: 'upload-cloud' },
                    { title: 'Sélection Techno', desc: 'FDM pour le volume, SLA pour la précision.', icon: 'layers' },
                    { title: 'Impression Express', desc: 'Vos pièces imprimées et expédiées en 24/48h.', icon: 'zap' }
                ],
                materials: ['PLA Standard', 'ABS Industriel', 'Résine Standard', 'Résine Tough', 'Nylon PA12'],
                gallery: ['bg-blue-200', 'bg-blue-300', 'bg-blue-400']
            },
            'sheet-metal': {
                id: 'sheet-metal',
                title: 'Tôlerie',
                subtitle: 'Découpe et pliage de précision pour vos châssis.',
                icon: 'layers',
                description: 'Découpe Laser & Pliage pour châssis métalliques.',
                longDescription: 'Solutions complètes de tôlerie fine industrielle. Découpe laser fibre haute puissance, pliage numérique et assemblage soudé pour vos châssis, boîtiers et supports en acier, alu ou inox.',
                benefits: ['Découpe Laser Fibre', 'Pliage CNC 7 axes', 'Soudure TIG/MIG', 'Peinture époxy'],
                steps: [
                    { title: 'Fichiers DXF/STEP', desc: 'Envoyez vos plans de découpe et pliage.', icon: 'file-check' },
                    { title: 'Validation Technique', desc: 'Nos ingénieurs vérifient la faisabilité.', icon: 'shield-check' },
                    { title: 'Fabrication', desc: 'Découpe, pliage, soudure et finition.', icon: 'factory' }
                ],
                materials: ['Acier S235', 'Alu 5754', 'Inox 304L', 'Inox 316L', 'Acier Galvanisé'],
                gallery: ['bg-amber-200', 'bg-amber-300', 'bg-amber-400']
            },
            'injection': {
                id: 'injection',
                title: 'Moulage Injection',
                subtitle: 'Production de série pour vos pièces plastiques.',
                icon: 'scan-line',
                description: 'Prototypes & Séries.',
                longDescription: 'Passez à la production de masse avec nos solutions de moulage par injection. Nous réalisons vos moules en acier ou aluminium et assurons l\'injection de vos séries en Algérie avec une qualité constante.',
                benefits: ['Moules "Low Cost" rapides', 'Grande capacité de production', 'Surmoulage', 'Large gamme de thermoplastiques'],
                steps: [
                    { title: 'Conception Moule', desc: 'Étude rhéologique et conception du moule.', icon: 'box' },
                    { title: 'Échantillons', desc: 'Validation des premières pièces (T0).', icon: 'check-circle' },
                    { title: 'Production Série', desc: 'Injection de vos milliers de pièces.', icon: 'factory' }
                ],
                materials: ['PP', 'PEHD', 'ABS', 'PC', 'PA66'],
                gallery: ['bg-emerald-200', 'bg-emerald-300', 'bg-emerald-400']
            }
        };

        const INDUSTRIES_DATA = [
            { id: 'auto', title: 'Automobile', icon: 'car', description: 'Pièces moteurs, fixations, prototypage.' },
            { id: 'aero', title: 'Aérospatial', icon: 'plane', description: 'Composants légers, haute résistance.' },
            { id: 'medical', title: 'Médical', icon: 'stethoscope', description: 'Instruments chirurgicaux, implants.' },
            { id: 'tech', title: 'Tech & IOT', icon: 'cpu', description: 'Boîtiers, dissipateurs thermiques.' },
            { id: 'naval', title: 'Naval', icon: 'anchor', description: 'Pièces résistantes à la corrosion.' },
            { id: 'conso', title: 'Biens de Conso', icon: 'smartphone', description: 'Design produits, électroménager.' }
        ];

        // Formations programmées (gérées par admin)
        let scheduledTrainings = [
            {
                id: 'TRAIN-001',
                title: 'Programmation CNC Avancée',
                instructor: 'Ing. Mohamed Benali',
                date: '2025-02-15',
                time: '09:00',
                duration: '3 jours',
                level: 'Avancé',
                price: 45000,
                seats: 20,
                booked: 12,
                location: 'Alger - Zone Industrielle Rouiba',
                description: 'Formation intensive sur la programmation G-Code et FAO avancée',
                icon: 'code-2',
                color: 'bg-blue-500'
            },
            {
                id: 'TRAIN-002',
                title: 'Maintenance Machines CNC',
                instructor: 'Ing. Karim Hamdi',
                date: '2025-02-20',
                time: '14:00',
                duration: '2 jours',
                level: 'Intermédiaire',
                price: 35000,
                seats: 15,
                booked: 8,
                location: 'Oran - Centre de Formation',
                description: 'Maintenance préventive et corrective des machines-outils CNC',
                icon: 'wrench',
                color: 'bg-green-500'
            }
        ];

        const TRAINING_DATA = [
            {
                id: 'fusion360-autodesk',
                title: 'Autodesk Fusion 360 - Formation Officielle',
                duration: 'Auto-rythmé',
                level: 'Débutant',
                price: 0,
                isFree: true,
                description: 'Cours officiel Autodesk CAM',
                icon: 'graduation-cap',
                color: 'bg-blue-500',
                details: 'Formation officielle Autodesk : CAO 3D, FAO, simulation et usinage. Accès gratuit aux tutoriels officiels et documentation complète.',
                url: 'https://www.autodesk.com/products/fusion-360/learn-training-tutorials'
            },
            {
                id: 'mit-opencourseware',
                title: 'MIT - Manufacturing Processes',
                duration: '12 semaines',
                level: 'Intermédiaire',
                price: 0,
                isFree: true,
                description: 'Cours MIT sur les procédés industriels',
                icon: 'book-open',
                color: 'bg-purple-500',
                details: 'Cours complet du MIT sur les processus de fabrication, l\'usinage CNC, et les technologies modernes. Inclut vidéos, exercices et examens.',
                url: 'https://ocw.mit.edu/courses/2-008-design-and-manufacturing-ii-spring-2004/'
            },
            {
                id: 'freecad-cnc',
                title: 'FreeCAD - CAM & CNC Path',
                duration: 'Auto-rythmé',
                level: 'Débutant',
                price: 0,
                isFree: true,
                description: 'Logiciel Open Source pour FAO',
                icon: 'cpu',
                color: 'bg-green-500',
                details: 'Apprenez à utiliser FreeCAD Path pour générer des parcours d\'outils CNC. 100% gratuit et open source avec documentation complète.',
                url: 'https://wiki.freecad.org/Path_Workbench'
            },
            {
                id: 'coursera-manufacturing',
                title: 'Coursera - Digital Manufacturing',
                duration: '4 semaines',
                level: 'Tous niveaux',
                price: 0,
                isFree: true,
                description: 'Fabrication numérique par University at Buffalo',
                icon: 'award',
                color: 'bg-red-500',
                details: 'Cours certifié sur la fabrication additive, CNC et technologies digitales. Audit gratuit disponible.',
                url: 'https://www.coursera.org/learn/digital-manufacturing-design-technology'
            },
            {
                id: 'haas-academy',
                title: 'Haas Automation Academy',
                duration: 'Auto-rythmé',
                level: 'Tous niveaux',
                price: 0,
                isFree: true,
                description: 'Formation CNC par Haas',
                icon: 'tool',
                color: 'bg-orange-500',
                details: 'Cours gratuits du fabricant HAAS sur la programmation CNC, maintenance et opération de machines-outils.',
                url: 'https://www.haascnc.com/productivity/education.html'
            },
            {
                id: 'edx-manufacturing',
                title: 'edX - Introduction to CAD/CAM',
                duration: '6 semaines',
                level: 'Débutant',
                price: 0,
                isFree: true,
                description: 'Cours universitaire gratuit',
                icon: 'monitor',
                color: 'bg-cyan-500',
                details: 'Formation complète sur CAO/FAO par des universités renommées. Certificat payant optionnel, cours 100% gratuit.',
                url: 'https://www.edx.org/learn/computer-aided-design'
            },
            {
                id: 'cnccookbook',
                title: 'CNC Cookbook - G-Code Tutorial',
                duration: 'Auto-rythmé',
                level: 'Débutant',
                price: 0,
                isFree: true,
                description: 'Guide complet G-Code gratuit',
                icon: 'code-2',
                color: 'bg-indigo-500',
                details: 'Tutoriels détaillés sur la programmation G-Code, trucs et astuces pour optimiser vos parcours d\'usinage.',
                url: 'https://www.cnccookbook.com/cnc-g-code-programming/'
            },
            {
                id: 'solidworks-tutorials',
                title: 'SolidWorks CAM - Tutoriels Officiels',
                duration: 'Auto-rythmé',
                level: 'Intermédiaire',
                price: 0,
                isFree: true,
                description: 'Ressources SolidWorks CAM',
                icon: 'box',
                color: 'bg-pink-500',
                details: 'Documentation et tutoriels officiels SolidWorks pour la FAO et la génération de parcours d\'outils CNC.',
                url: 'https://www.solidworks.com/support/resource-center'
            }
        ];

        const PARTS_DATA = [
            {
                id: 'spindle',
                name: 'Broche HSD 18000 rpm',
                category: 'Broches',
                price: 450000,
                stock: 'En stock',
                image: 'bg-gradient-to-br from-slate-700 to-slate-900',
                description: 'Broche électrique haute vitesse pour fraisage aluminium'
            },
            {
                id: 'ballscrew',
                name: 'Vis à billes THK Ø32',
                category: 'Transmission',
                price: 85000,
                stock: 'En stock',
                image: 'bg-gradient-to-br from-blue-600 to-blue-800',
                description: 'Précision C3, longueur 1500mm'
            },
            {
                id: 'endmill',
                name: 'Set Fraises Carbure',
                category: 'Outils',
                price: 25000,
                stock: 'En stock',
                image: 'bg-gradient-to-br from-amber-500 to-amber-700',
                description: 'Kit 10 fraises Ø4-Ø12mm revêtement TiAlN'
            },
            {
                id: 'coolant',
                name: 'Lubrifiant Soluble 20L',
                category: 'Consommables',
                price: 12000,
                stock: 'En stock',
                image: 'bg-gradient-to-br from-green-500 to-green-700',
                description: 'Lubrifiant de coupe universel, bidon 20L'
            },
            {
                id: 'controller',
                name: 'Contrôleur Siemens 840D',
                category: 'Électronique',
                price: 850000,
                stock: 'Sur commande',
                image: 'bg-gradient-to-br from-purple-600 to-purple-800',
                description: 'Contrôleur CNC nouvelle génération'
            },
            {
                id: 'probe',
                name: 'Palpeur 3D Renishaw',
                category: 'Mesure',
                price: 320000,
                stock: 'En stock',
                image: 'bg-gradient-to-br from-red-500 to-red-700',
                description: 'Palpeur de précision sans fil'
            }
        ];

        // ==================== NAVIGATION ====================
        function navigateTo(route, data = null) {
            AppState.currentRoute = route;
            AppState.activeData = data;
            AppState.isMenuOpen = false;
            AppState.isSearchOpen = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function switchView(view) {
            AppState.currentView = view;
            render();
        }

        function toggleMenu() {
            AppState.isMenuOpen = !AppState.isMenuOpen;
            render();
        }

        function toggleSearch() {
            AppState.isSearchOpen = !AppState.isSearchOpen;
            render();
        }

        function toggleChat() {
            AppState.chatState.isOpen = !AppState.chatState.isOpen;
            AppState.chatState.unreadCount = 0;
            render();
        }

        // ==================== CHAT ====================
        function sendChatMessage(text) {
            if (!text.trim()) return;

            const newMessage = {
                id: Date.now(),
                text: text,
                sender: 'user',
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };

            AppState.chatState.messages.push(newMessage);
            render();

            // Simulate typing
            setTimeout(() => {
                AppState.chatState.isTyping = true;
                render();
            }, 1000);

            // Simulate reply
            setTimeout(() => {
                let replyText = "Un ingénieur va examiner votre demande sous peu.";
                if (text.toLowerCase().includes('délai')) replyText = "Bonjour ! Nous avons reçu la matière, nous commençons l'usinage demain matin.";
                if (text.toLowerCase().includes('prix')) replyText = "Le prix est calculé automatiquement selon la géométrie et la matière.";
                if (text.toLowerCase().includes('formation')) replyText = "Nous proposons plusieurs formations du niveau débutant à avancé. Consultez notre section Formations.";

                const reply = {
                    id: Date.now() + 1,
                    text: replyText,
                    sender: 'engineer',
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };

                AppState.chatState.messages.push(reply);
                AppState.chatState.isTyping = false;
                if (!AppState.chatState.isOpen) AppState.chatState.unreadCount++;
                render();
            }, 3500);
        }

        // ==================== UPLOAD & ANALYSIS ====================
        function handleUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.stl,.step,.stp,.iges,.igs,.obj';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                AppState.uploadState.status = 'uploading';
                AppState.uploadState.progress = 0;
                AppState.uploadState.fileData = { name: file.name, size: file.size };
                render();

                const reader = new FileReader();
                reader.onprogress = (event) => {
                    if (event.lengthComputable) {
                        AppState.uploadState.progress = Math.round((event.loaded / event.total) * 100);
                        render();
                    }
                };
                reader.onload = (event) => {
                    AppState.uploadState.progress = 100;
                    render();
                    setTimeout(() => startAnalysis(event.target.result, file.name), 500);
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }

        function startAnalysis(fileBuffer, fileName) {
            AppState.uploadState.status = 'analyzing';
            render();

            setTimeout(() => {
                AppState.uploadState.status = 'complete';
                AppState.uploadState.fileData = {
                    name: fileName,
                    preview: true,
                    buffer: fileBuffer
                };

                // Parse real STL file to extract geometry data
                const geoData = parseSTLFile(fileBuffer, fileName);
                AppState.uploadState.geoData = geoData;

                render();
                startDFMAnalysis();
                calculatePrice();

                // Appeler init3DViewer APRÈS que le DOM soit rendu
                setTimeout(() => {
                    init3DViewer(fileBuffer, fileName);
                }, 100);
            }, 2000);
        }

        // ==================== STL PARSER AVANCÉ ====================
        function parseSTLFile(arrayBuffer, fileName) {
            const ext = fileName.split('.').pop().toLowerCase();

            // Analyse précise uniquement pour les fichiers STL côté client
            if (ext === 'stl' && typeof THREE !== 'undefined' && typeof THREE.STLLoader !== 'undefined') {
                try {
                    const loader = new THREE.STLLoader();
                    const geometry = loader.parse(arrayBuffer);

                    geometry.computeBoundingBox();
                    const box = geometry.boundingBox;
                    const size = new THREE.Vector3();
                    box.getSize(size);

                    const width = size.x;
                    const height = size.y;
                    const depth = size.z;

                    // Volume approximatif (bounding box) en cm³
                    const volume = (width * height * depth) / 1000;

                    const vertexCount = geometry.attributes.position ? geometry.attributes.position.count : 0;
                    const faceCount = vertexCount / 3;

                    // ========== ANALYSE AVANCÉE ==========

                    // 1. Détection Features Géométriques
                    const features = detectGeometricFeatures(geometry, size);

                    // 2. Analyse Épaisseurs de Paroi
                    const wallThickness = analyzeWallThickness(geometry, size);

                    // 3. Score Complexité Détaillé
                    const complexityScore = calculateComplexityScore(vertexCount, faceCount, features, wallThickness);

                    // 4. Analyse Surface/Volume Ratio
                    const surfaceArea = calculateSurfaceArea(geometry);
                    const svRatio = surfaceArea / (volume || 1);

                    // 5. Détection Zones Difficiles
                    const difficultZones = detectDifficultZones(geometry);

                    // On mémorise la géométrie si besoin plus tard
                    AppState.uploadState.stlGeometry = geometry;

                    return {
                        // Données basiques
                        volume: Math.abs(volume),
                        dimensions: `${Math.abs(width).toFixed(1)} x ${Math.abs(height).toFixed(1)} x ${Math.abs(depth).toFixed(1)} mm`,
                        vertexCount: vertexCount,
                        faceCount: faceCount,

                        // Analyses avancées
                        features: features,
                        wallThickness: wallThickness,
                        complexity: complexityScore,
                        surfaceArea: surfaceArea.toFixed(1),
                        svRatio: svRatio.toFixed(2),
                        difficultZones: difficultZones,

                        // Recommandations
                        recommendations: generateRecommendations(features, wallThickness, complexityScore)
                    };
                } catch (e) {
                    console.error('Erreur lors de la lecture du STL :', e);
                    return generateDefaultGeometry(fileName);
                }
            }

            // Pour STEP / IGES / OBJ ou si le loader n'est pas dispo, on renvoie des valeurs génériques
            return generateDefaultGeometry(fileName);
        }

        // Détection de features géométriques
        function detectGeometricFeatures(geometry, size) {
            const features = {
                holes: 0,
                pockets: 0,
                threads: 0,
                flatSurfaces: 0,
                curvedSurfaces: 0
            };

            // Analyse simplifiée basée sur la géométrie
            const vertexCount = geometry.attributes.position.count;

            // Estimation du nombre de trous/alésages basé sur la complexité
            const maxDim = Math.max(size.x, size.y, size.z);
            features.holes = Math.floor(vertexCount / 5000); // Approximation

            // Estimation poches
            features.pockets = Math.floor(vertexCount / 8000);

            // Détection surfaces planes vs courbes (par ratio de normalités)
            const normals = geometry.attributes.normal;
            if (normals) {
                let planarCount = 0;
                for (let i = 0; i < normals.count; i += 100) {
                    const nx = normals.getX(i);
                    const ny = normals.getY(i);
                    const nz = normals.getZ(i);
                    // Si normale proche d'un axe cardinal = surface plane
                    if (Math.abs(nx) > 0.95 || Math.abs(ny) > 0.95 || Math.abs(nz) > 0.95) {
                        planarCount++;
                    }
                }
                const sampledCount = Math.ceil(normals.count / 100);
                const planarRatio = planarCount / sampledCount;
                features.flatSurfaces = Math.floor(planarRatio * 10);
                features.curvedSurfaces = 10 - features.flatSurfaces;
            }

            return features;
        }

        // Analyse épaisseur de paroi
        function analyzeWallThickness(geometry, size) {
            const maxDim = Math.max(size.x, size.y, size.z);
            const minDim = Math.min(size.x, size.y, size.z);

            // Estimation basique
            const estimatedMin = minDim / 10;
            const estimatedMax = maxDim / 5;

            return {
                min: estimatedMin.toFixed(2),
                max: estimatedMax.toFixed(2),
                hasThinWalls: estimatedMin < 1.5,
                warnings: estimatedMin < 1.5 ? ['Parois fines détectées (<1.5mm)'] : []
            };
        }

        // Calcul score complexité
        function calculateComplexityScore(vertexCount, faceCount, features, wallThickness) {
            let score = 0;

            // Complexité géométrique (0-40 points)
            if (vertexCount < 1000) score += 5;
            else if (vertexCount < 5000) score += 15;
            else if (vertexCount < 15000) score += 30;
            else score += 40;

            // Features (0-30 points)
            const totalFeatures = features.holes + features.pockets + features.threads;
            score += Math.min(30, totalFeatures * 3);

            // Surfaces courbes (0-20 points)
            score += features.curvedSurfaces * 2;

            // Parois fines (0-10 points)
            if (wallThickness.hasThinWalls) score += 10;

            return {
                score: Math.min(100, score),
                level: score < 30 ? 'Simple' : score < 60 ? 'Moyen' : score < 80 ? 'Complexe' : 'Très Complexe',
                breakdown: {
                    geometry: Math.min(40, vertexCount / 500),
                    features: Math.min(30, totalFeatures * 3),
                    surfaces: features.curvedSurfaces * 2,
                    walls: wallThickness.hasThinWalls ? 10 : 0
                }
            };
        }

        // Calcul surface
        function calculateSurfaceArea(geometry) {
            let area = 0;
            const positions = geometry.attributes.position;

            // Calcul simplifié en prenant un échantillon de triangles
            for (let i = 0; i < positions.count; i += 300) {
                if (i + 2 < positions.count) {
                    const v0 = [positions.getX(i), positions.getY(i), positions.getZ(i)];
                    const v1 = [positions.getX(i + 1), positions.getY(i + 1), positions.getZ(i + 1)];
                    const v2 = [positions.getX(i + 2), positions.getY(i + 2), positions.getZ(i + 2)];

                    // Aire triangle
                    const a = Math.sqrt(Math.pow(v1[0] - v0[0], 2) + Math.pow(v1[1] - v0[1], 2) + Math.pow(v1[2] - v0[2], 2));
                    const b = Math.sqrt(Math.pow(v2[0] - v1[0], 2) + Math.pow(v2[1] - v1[1], 2) + Math.pow(v2[2] - v1[2], 2));
                    const c = Math.sqrt(Math.pow(v0[0] - v2[0], 2) + Math.pow(v0[1] - v2[1], 2) + Math.pow(v0[2] - v2[2], 2));
                    const s = (a + b + c) / 2;
                    area += Math.sqrt(s * (s - a) * (s - b) * (s - c));
                }
            }

            // Extrapoler sur toutes les faces
            const samplingRatio = positions.count / 300;
            return area * samplingRatio / 100; // cm²
        }

        // Détection zones difficiles
        function detectDifficultZones(geometry) {
            const zones = [];
            const normals = geometry.attributes.normal;

            if (normals) {
                // Chercher des changements brusques de normale (arêtes vives)
                let sharpEdges = 0;
                for (let i = 0; i < normals.count - 1; i += 100) {
                    const n1 = [normals.getX(i), normals.getY(i), normals.getZ(i)];
                    const n2 = [normals.getX(i + 1), normals.getY(i + 1), normals.getZ(i + 1)];

                    // Produit scalaire pour angle
                    const dot = n1[0] * n2[0] + n1[1] * n2[1] + n1[2] * n2[2];
                    if (dot < 0.7) sharpEdges++; // Angle > ~45°
                }

                if (sharpEdges > 10) {
                    zones.push('Arêtes vives multiples');
                }
            }

            return zones;
        }

        // Génération recommandations
        function generateRecommendations(features, wallThickness, complexity) {
            const recs = [];

            // Recommandations parois
            if (wallThickness.hasThinWalls) {
                recs.push({
                    type: 'warning',
                    category: 'Structure',
                    title: 'Épaisseur de paroi faible',
                    message: `Épaisseur min. ${wallThickness.min}mm détectée. Recommandation : ≥2mm pour rigidité`,
                    impact: 'Risque déformation',
                    solution: 'Augmenter épaisseur à 2-3mm'
                });
            }

            // Recommandations complexité
            if (complexity.score > 70) {
                recs.push({
                    type: 'info',
                    category: 'Usinage',
                    title: 'Pièce complexe détectée',
                    message: `Score complexité: ${complexity.score}/100. Temps usinage augmenté.`,
                    impact: '+30-50% temps',
                    solution: 'Simplifier géométrie si possible'
                });
            }

            // Recommandations features
            if (features.holes > 5) {
                recs.push({
                    type: 'success',
                    category: 'Optimisation',
                    title: 'Perçages multiples',
                    message: `${features.holes} trous détectés. Utiliser diamètres standards.`,
                    impact: 'Économie outillage',
                    solution: 'Diamètres: 3, 4, 5, 6, 8, 10, 12mm (standards)'
                });
            }

            // Recommandation process
            if (complexity.score < 40 && features.curvedSurfaces < 3) {
                recs.push({
                    type: 'success',
                    category: 'Process',
                    title: 'Géométrie simple',
                    message: 'Usinage 3 axes suffisant',
                    impact: '-40% coût vs 5 axes',
                    solution: 'Fraisage 3 axes standard recommandé'
                });
            }

            return recs;
        }

        function generateDefaultGeometry(fileName) {
            // Valeurs par défaut pour démo ou formats non supportés
            return {
                volume: 125.5,
                dimensions: '50.0 x 50.0 x 50.0 mm',
                vertexCount: 2400,
                complexity: 'Medium'
            };
        }

        function startDFMAnalysis() {
            AppState.dfmState.status = 'analyzing';
            render();

            setTimeout(() => {
                const geoData = AppState.uploadState.geoData;

                // ========== SCORING DFM SOPHISTIQUÉ ==========
                let dfmScore = 0;
                const scoreBreakdown = {
                    machinability: 0,   // Usinabilité (40 pts)
                    manufacturability: 0, // Fabricabilité (30 pts)
                    cost: 0,            // Coût (20 pts)
                    quality: 0          // Qualité (10 pts)
                };

                // 1. USINABILITÉ (40 points max)
                if (geoData && geoData.complexity) {
                    // Pénalité sur complexité
                    const complexityPenalty = geoData.complexity.score / 100 * 20; // max 20 pts penalty
                    scoreBreakdown.machinability = 40 - complexityPenalty;

                    // Bonus si géométrie simple
                    if (geoData.complexity.level === 'Simple') {
                        scoreBreakdown.machinability += 5;
                    }

                    // Pénalité surfaces courbes
                    if (geoData.features && geoData.features.curvedSurfaces > 5) {
                        scoreBreakdown.machinability -= 5;
                    }
                }

                // 2. FABRICABILITÉ (30 points max)
                if (geoData) {
                    scoreBreakdown.manufacturability = 30;

                    // Pénalité parois fines
                    if (geoData.wallThickness && geoData.wallThickness.hasThinWalls) {
                        scoreBreakdown.manufacturability -= 10;
                    }

                    // Bonus features standards
                    if (geoData.features && geoData.features.holes > 0) {
                        scoreBreakdown.manufacturability += 3;
                    }

                    // Pénalité zones difficiles
                    if (geoData.difficultZones && geoData.difficultZones.length > 0) {
                        scoreBreakdown.manufacturability -= 5;
                    }
                }

                // 3. COÛT (20 points max)
                if (geoData) {
                    scoreBreakdown.cost = 20;

                    // Pénalité volume élevé
                    if (geoData.volume > 1000) {
                        scoreBreakdown.cost -= 5;
                    }

                    // Pénalité ratio surface/volume élevé
                    if (geoData.svRatio && parseFloat(geoData.svRatio) > 15) {
                        scoreBreakdown.cost -= 5;
                    }
                }

                // 4. QUALITÉ (10 points max)
                scoreBreakdown.quality = 10;
                if (geoData && geoData.complexity && geoData.complexity.score > 70) {
                    scoreBreakdown.quality -= 3; // Complexe = plus difficile à contrôler
                }

                // Score total
                dfmScore = Math.max(0, Math.min(100,
                    scoreBreakdown.machinability +
                    scoreBreakdown.manufacturability +
                    scoreBreakdown.cost +
                    scoreBreakdown.quality
                ));

                // ========== GÉNÉRATION ALERTES INTELLIGENTES ==========
                const alerts = [];

                // Utiliser les recommandations générées
                if (geoData && geoData.recommendations) {
                    geoData.recommendations.forEach(rec => {
                        let icon = 'info';
                        if (rec.type === 'warning') icon = 'alert-triangle';
                        if (rec.type === 'success') icon = 'check-circle';

                        alerts.push({
                            type: rec.type,
                            icon: icon,
                            message: rec.message,
                            category: rec.category,
                            impact: rec.impact,
                            solution: rec.solution
                        });
                    });
                }

                // Alertes additionnelles basées sur score
                if (dfmScore < 60) {
                    alerts.push({
                        type: 'warning',
                        icon: 'alert-circle',
                        message: `Score DFM faible (${Math.round(dfmScore)}/100). Optimisation recommandée.`,
                        category: 'Global',
                        impact: 'Coût et délais augmentés',
                        solution: 'Consulter les recommandations ci-dessus'
                    });
                } else if (dfmScore > 85) {
                    alerts.push({
                        type: 'success',
                        icon: 'thumbs-up',
                        message: `Excellent score DFM (${Math.round(dfmScore)}/100). Pièce optimale pour l'usinage.`,
                        category: 'Global',
                        impact: 'Fabrication efficace',
                        solution: 'Aucune modification nécessaire'
                    });
                }

                // Alerte process recommandé
                if (geoData && geoData.features) {
                    const totalFeatures = geoData.features.holes + geoData.features.pockets;
                    if (totalFeatures === 0 && geoData.features.curvedSurfaces < 2) {
                        alerts.push({
                            type: 'info',
                            icon: 'tool',
                            message: 'Géométrie adaptée au tournage',
                            category: 'Process',
                            impact: 'Potentiel -30% coût',
                            solution: 'Considérer tournage CNC si pièce de révolution'
                        });
                    }
                }

                AppState.dfmState.status = 'complete';
                AppState.dfmState.report = {
                    score: Math.round(dfmScore),
                    scoreBreakdown: scoreBreakdown,
                    alerts: alerts,
                    geoData: geoData // Garder référence pour affichage détaillé
                };
                render();
            }, 2500);
        }

        function calculatePrice() {
            const geoData = AppState.uploadState.geoData;
            if (!geoData) return;

            // 1. Base Constants
            const DENSITY = {
                'Aluminium 6061-T6': 2.7, 'Aluminium 7075-T6': 2.8,
                'Acier Inoxydable 304L': 7.9, 'Acier Inoxydable 316L': 8.0,
                'PEEK': 1.3, 'Delrin (Acétal)': 1.4
            };
            const MATERIAL_PRICE = {
                'Aluminium 6061-T6': 600, 'Aluminium 7075-T6': 900,
                'Acier Inoxydable 304L': 1200, 'Acier Inoxydable 316L': 1500,
                'PEEK': 12000, 'Delrin (Acétal)': 2500
            };

            // 2. Finish Multipliers
            const FINISH_MULTIPLIER = {
                "Brut d'usinage (Standard)": 1.0,
                "Anodisation Incolore (Type II)": 1.15,
                "Anodisation Dure (Type III)": 1.25,
                "Microbillage (Sablage)": 1.10,
                "Peinture Poudre (Epoxy)": 1.20,
                "Polissage Miroir": 1.40
            };

            // 3. Tolerance Multipliers
            const TOLERANCE_MULTIPLIER = {
                "Standard (ISO 2768-m)": 1.0,
                "Précision (ISO 2768-f)": 1.25,
                "Haute Précision (+/- 0.01mm)": 1.50
            };

            // 4. Delivery Multipliers
            const DELIVERY_MULTIPLIER = {
                "Eco (J+15)": 0.85,
                "Standard (J+7)": 1.0,
                "Express (J+3)": 1.4,
                "Urgence (J+1)": 2.0
            };

            // Calculation
            const density = DENSITY[AppState.config.material] || 2.7;
            const matPricePerKg = MATERIAL_PRICE[AppState.config.material] || 600;
            const weightKg = (geoData.volume * density) / 1000;
            const rawMaterialCost = weightKg * matPricePerKg;

            // Machining Cost
            const hourlyRate = 2500;
            const complexityFactor = 1 + (geoData.vertexCount / 5000);
            const machiningTimeHours = ((geoData.volume / 50) * complexityFactor * 5) / 60;
            let machiningCost = machiningTimeHours * hourlyRate;

            // Apply Multipliers
            const finishMult = FINISH_MULTIPLIER[AppState.config.finish] || 1.0;
            const toleranceMult = TOLERANCE_MULTIPLIER[AppState.config.tolerance] || 1.0;
            const deliveryMult = DELIVERY_MULTIPLIER[AppState.config.delivery] || 1.0;

            machiningCost = machiningCost * finishMult * toleranceMult;

            // Certificate Costs (Flat fee)
            let certCost = 0;
            if (AppState.config.certificates.includes('Certificat Matière (3.1)')) certCost += 2500;
            if (AppState.config.certificates.includes('Rapport de Contrôle')) certCost += 5000;

            // Total Unit Price
            let unitPrice = (rawMaterialCost + machiningCost) * deliveryMult + (certCost / AppState.config.quantity);

            // Quantity Discount
            const qtyDiscount = Math.max(0.6, 1 - Math.log10(AppState.config.quantity) * 0.15);
            unitPrice = Math.round(unitPrice * qtyDiscount);

            AppState.price = {
                unit: unitPrice,
                total: unitPrice * AppState.config.quantity,
                breakdown: {
                    material: Math.round(rawMaterialCost),
                    machining: Math.round(machiningCost * deliveryMult),
                    options: Math.round(certCost),
                    time: Math.round(machiningTimeHours * 60)
                }
            };

            render();
        }

        function updateConfig(key, value) {
            AppState.config[key] = value;
            calculatePrice();
        }

        function addToCart() {
            const newOrder = {
                id: `DZ-2024-${String(Date.now()).slice(-3)}`,
                client: 'Moi',
                file: AppState.uploadState.fileData.name,
                status: 'WAITING',
                date: new Date().toLocaleDateString('fr-FR'),
                price: AppState.price.total,
                config: { ...AppState.config }
            };

            AppState.orders.unshift(newOrder);
            alert('✅ Devis ajouté au panier !');
            navigateTo('PROFILE');
        }

        // ==================== 3D VIEWER ====================
        let scene, camera, renderer, controls, model;

        function init3DViewer(fileBuffer, fileName) {
            const container = document.getElementById('canvas-container');
            if (!container) {
                console.error('Canvas container not found');
                return;
            }

            // Clear container
            container.innerHTML = '';

            // Create scene
            if (!scene) scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf8f9fa);

            // Create camera
            const aspect = container.clientWidth / container.clientHeight;
            camera = new THREE.PerspectiveCamera(50, aspect, 0.1, 1000);
            camera.position.set(5, 5, 5);

            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Add lights
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(10, 10, 10);
            scene.add(light);

            // Load and display STL
            const ext = fileName.split('.').pop().toLowerCase();

            if (ext === 'stl' && AppState.uploadState.stlGeometry) {
                const geometry = AppState.uploadState.stlGeometry;

                // Center geometry
                geometry.center();

                // Create material
                const material = new THREE.MeshStandardMaterial({
                    color: 0x778899,
                    metalness: 0.8,
                    roughness: 0.2
                });

                // Remove old model if exists
                if (model) scene.remove(model);

                // Create mesh
                model = new THREE.Mesh(geometry, material);
                scene.add(model);

                // Adjust camera position based on model size
                geometry.computeBoundingBox();
                const box = geometry.boundingBox;
                const size = new THREE.Vector3();
                box.getSize(size);
                const diag = size.length();
                camera.position.set(diag, diag, diag);

            } else {
                // Fallback demo geometry
                const geometry = new THREE.BoxGeometry(2, 2, 2);
                const material = new THREE.MeshStandardMaterial({
                    color: 0x778899,
                    metalness: 0.8,
                    roughness: 0.2
                });

                if (model) scene.remove(model);
                model = new THREE.Mesh(geometry, material);
                scene.add(model);
            }

            // Setup controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 2;
            controls.target.set(0, 0, 0);
            controls.update();

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // Handle window resize
            window.addEventListener('resize', () => {
                const c = document.getElementById('canvas-container');
                if (!c) return;
                camera.aspect = c.clientWidth / c.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(c.clientWidth, c.clientHeight);
            });
        }

        // ==================== RENDER FUNCTIONS ====================

        function renderHeader() {
            return `
                <header class="sticky top-0 z-40 glass-effect shadow-sm px-4 h-16 flex items-center justify-between">
                    <div class="flex items-center gap-2 cursor-pointer" onclick="navigateTo('HOME')">
                        <div class="gradient-primary text-white p-1.5 rounded-lg">
                            <i data-lucide="box" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xl font-black text-[#005f9e] tracking-tight hidden sm:block">CNC CONNECT</span>
                        <span class="text-xl font-black text-[#005f9e] tracking-tight sm:hidden">CNC</span>
                    </div>

                    <!-- View Switcher -->
                    <div class="flex items-center bg-slate-100 rounded-full p-1 border border-slate-200">
                        <button onclick="switchView('CLIENT')" class="px-3 py-1.5 rounded-full text-xs font-bold transition-all ${AppState.currentView === 'CLIENT' ? 'bg-white text-[#005f9e] shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                            Client
                        </button>
                        <button onclick="switchView('FACTORY')" class="px-3 py-1.5 rounded-full text-xs font-bold transition-all ${AppState.currentView === 'FACTORY' ? 'bg-white text-[#005f9e] shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                            Usine
                        </button>
                        <button onclick="switchView('ADMIN')" class="px-3 py-1.5 rounded-full text-xs font-bold transition-all ${AppState.currentView === 'ADMIN' ? 'bg-red-500 text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                            Admin
                        </button>
                    </div>

                    <div class="flex items-center gap-2">
                        <button onclick="toggleSearch()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                            <i data-lucide="search" class="w-5 h-5"></i>
                        </button>
                        <button onclick="toggleMenu()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-full transition-colors relative">
                            <i data-lucide="menu" class="w-5 h-5"></i>
                            ${AppState.chatState.unreadCount > 0 ? `<span class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>` : ''}
                        </button>
                    </div>
                </header>
            `;
        }

        function renderBottomNav() {
            const navItems = [
                { icon: 'home', label: 'Accueil', route: 'HOME' },
                { icon: 'plus', label: 'Devis', route: 'QUOTE', isMain: true },
                { icon: 'graduation-cap', label: 'Formation', route: 'TRAINING' },
                { icon: 'user-cog', label: 'Compte', route: 'PROFILE' }
            ];

            return `
                <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 h-16 flex items-center justify-around z-40 shadow-lg">
                    ${navItems.map(item => `
                        <button onclick="navigateTo('${item.route}')" class="flex flex-col items-center justify-center gap-1 w-full h-full ${AppState.currentRoute === item.route ? 'text-[#005f9e]' : 'text-slate-400 hover:text-slate-600'} transition-colors">
                            ${item.isMain ? `
                                <div class="gradient-primary text-white p-3 rounded-full -mt-8 shadow-lg border-4 border-white">
                                    <i data-lucide="${item.icon}" class="w-6 h-6"></i>
                                </div>
                            ` : `
                                <i data-lucide="${item.icon}" class="w-6 h-6"></i>
                            `}
                            <span class="text-[10px] font-bold">${item.label}</span>
                        </button>
                    `).join('')}
                </nav>
            `;
        }

        function renderMenu() {
            if (!AppState.isMenuOpen) return '';

            return `
                <div class="fixed inset-0 z-50 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleMenu()"></div>
                    <div class="absolute inset-y-0 right-0 w-[80%] max-w-sm bg-white shadow-2xl p-6 flex flex-col animate-slide-in-right">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-xl font-black text-slate-900">Menu</h2>
                            <button onclick="toggleMenu()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <nav class="space-y-4 flex-1">
                            <button onclick="navigateTo('HOME')" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-slate-50 font-bold text-slate-700 transition-colors">
                                <i data-lucide="home" class="w-5 h-5"></i> Accueil
                            </button>
                            <button onclick="navigateTo('QUOTE')" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-slate-50 font-bold text-slate-700 transition-colors">
                                <i data-lucide="plus" class="w-5 h-5"></i> Nouveau Devis
                            </button>
                            <button onclick="navigateTo('TRAINING')" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-slate-50 font-bold text-slate-700 transition-colors">
                                <i data-lucide="graduation-cap" class="w-5 h-5"></i> Formations
                            </button>
                            <button onclick="navigateTo('PARTS')" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-slate-50 font-bold text-slate-700 transition-colors">
                                <i data-lucide="wrench" class="w-5 h-5"></i> Pièces & Consommables
                            </button>
                            <button onclick="navigateTo('MAINTENANCE')" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-slate-50 font-bold text-slate-700 transition-colors">
                                <i data-lucide="settings" class="w-5 h-5"></i> Maintenance
                            </button>
                            <button onclick="navigateTo('NETWORK')" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-slate-50 font-bold text-slate-700 transition-colors">
                                <i data-lucide="network" class="w-5 h-5"></i> Réseau Partenaires
                            </button>
                            <div class="h-px bg-slate-100 my-2"></div>
                            <button onclick="navigateTo('PROFILE')" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-slate-50 font-bold text-slate-700 transition-colors">
                                <i data-lucide="user-cog" class="w-5 h-5"></i> Mon Profil
                            </button>
                        </nav>
                        
                        <div class="p-4 bg-slate-50 rounded-xl">
                            <p class="text-xs text-slate-400 text-center">CNC Connect App v1.0.0</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSearchModal() {
            if (!AppState.isSearchOpen) return '';

            return `
                <div class="fixed inset-0 z-50 flex flex-col bg-white animate-scale-in">
                    <div class="p-4 border-b border-slate-100 flex items-center gap-4">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400"></i>
                        <input
                            id="search-input"
                            type="text"
                            placeholder="Rechercher un service, une formation..."
                            class="flex-1 text-lg font-medium focus:outline-none"
                            autofocus
                        />
                        <button onclick="toggleSearch()" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="text-center text-slate-400 mt-10">Commencez à taper pour rechercher...</div>
                    </div>
                </div>
            `;
        }

        function renderChatPanel() {
            if (!AppState.chatState.isOpen) return '';

            return `
                <div class="fixed bottom-24 right-4 w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 z-50 flex flex-col overflow-hidden animate-scale-in" style="height: 500px; max-height: 80vh">
                    <!-- Header -->
                    <div class="gradient-primary p-4 flex items-center justify-between text-white">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold">ENG</div>
                                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-[#005f9e]"></div>
                            </div>
                            <div>
                                <div class="font-bold text-sm">Support Technique</div>
                                <div class="text-xs text-blue-200">En ligne • Répond en < 5min</div>
                            </div>
                        </div>
                        <button onclick="toggleChat()" class="p-1.5 hover:bg-white/10 rounded-lg transition-colors">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Messages -->
                    <div id="chat-messages" class="flex-1 bg-slate-50 p-4 overflow-y-auto space-y-4 hide-scrollbar">
                        <div class="text-center text-xs text-slate-400 my-4">Aujourd'hui</div>
                        ${AppState.chatState.messages.map(msg => `
                            <div class="flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}">
                                <div class="chat-bubble p-3 rounded-2xl text-sm ${msg.sender === 'user' ? 'bg-[#005f9e] text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none shadow-sm'}">
                                    ${msg.text}
                                    <div class="text-[10px] mt-1 text-right ${msg.sender === 'user' ? 'text-blue-200' : 'text-slate-400'}">
                                        ${msg.timestamp}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${AppState.chatState.isTyping ? `
                            <div class="flex justify-start">
                                <div class="bg-white border border-slate-200 px-4 py-3 rounded-2xl rounded-tl-none shadow-sm flex gap-1">
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></div>
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Input -->
                    <form onsubmit="event.preventDefault(); sendChatMessage(document.getElementById('chat-input').value); document.getElementById('chat-input').value = '';" class="p-3 bg-white border-t border-slate-100 flex gap-2">
                        <input
                            id="chat-input"
                            type="text"
                            placeholder="Écrivez votre message..."
                            class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <button type="submit" class="gradient-primary text-white p-2.5 rounded-xl hover:opacity-90 transition-opacity">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            `;
        }

        function renderFloatingChat() {
            return `
                <div class="fixed bottom-20 right-4 z-40">
                    <button onclick="toggleChat()" class="gradient-primary text-white p-4 rounded-full shadow-xl hover:shadow-2xl transition-all hover:scale-105 relative">
                        <i data-lucide="message-circle" class="w-6 h-6"></i>
                        ${AppState.chatState.unreadCount > 0 ? `
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white">
                                ${AppState.chatState.unreadCount}
                            </span>
                        ` : ''}
                    </button>
                </div>
            `;
        }

        // ==================== PAGE RENDERS ====================

        function renderHomePage() {
            return `
                <div class="p-4 space-y-6 animate-slide-up">
                    <!-- Hero Section -->
                    <section class="gradient-hero rounded-2xl p-8 shadow-lg text-white text-center space-y-4 relative overflow-hidden">
                        <div class="absolute inset-0 bg-black/10"></div>
                        <div class="relative z-10">
                            <h1 class="text-3xl font-black leading-tight">La production à la demande pour vos projets</h1>
                            <p class="text-blue-100 text-sm">De la pièce unique à la série, accédez à un réseau de 500+ ateliers qualifiés.</p>
                            <button onclick="navigateTo('QUOTE')" class="w-full bg-white text-[#005f9e] font-bold py-3.5 rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 mt-4">
                                Obtenir un devis instantané <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                            <div class="flex justify-center gap-4 pt-4">
                                <div class="flex items-center gap-1 text-xs font-bold bg-white/20 px-3 py-1.5 rounded-full backdrop-blur-sm">
                                    <i data-lucide="shield-check" class="w-4 h-4"></i> ISO 9001
                                </div>
                                <div class="flex items-center gap-1 text-xs font-bold bg-white/20 px-3 py-1.5 rounded-full backdrop-blur-sm">
                                    <i data-lucide="zap" class="w-4 h-4"></i> J+3
                                </div>
                                <div class="flex items-center gap-1 text-xs font-bold bg-white/20 px-3 py-1.5 rounded-full backdrop-blur-sm">
                                    <i data-lucide="globe" class="w-4 h-4"></i> Algérie
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Services -->
                    <section>
                        <h2 class="text-lg font-black text-slate-900 mb-3 px-1">Nos Services</h2>
                        <div class="space-y-3">
                            ${Object.values(SERVICES_DATA).map(service => `
                                <div onclick="navigateTo('SERVICE_DETAIL', SERVICES_DATA['${service.id}'])" class="service-card bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between cursor-pointer group">
                                    <div class="flex items-center gap-4">
                                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-3 rounded-xl group-hover:from-blue-100 group-hover:to-blue-200 transition-all">
                                            <i data-lucide="${service.icon}" class="w-6 h-6 text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-slate-900">${service.title}</h3>
                                            <p class="text-xs text-slate-500">${service.description}</p>
                                        </div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 group-hover:text-blue-600 transition-colors"></i>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <!-- Quick Access -->
                    <section>
                        <h2 class="text-lg font-black text-slate-900 mb-3 px-1">Accès Rapide</h2>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="navigateTo('TRAINING')" class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all text-left">
                                <i data-lucide="graduation-cap" class="w-8 h-8 mb-2"></i>
                                <div class="font-bold">Formations</div>
                                <div class="text-xs text-purple-100">Apprenez le CNC</div>
                            </button>
                            <button onclick="navigateTo('PARTS')" class="bg-gradient-to-br from-amber-500 to-amber-600 text-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all text-left">
                                <i data-lucide="wrench" class="w-8 h-8 mb-2"></i>
                                <div class="font-bold">Pièces</div>
                                <div class="text-xs text-amber-100">Boutique en ligne</div>
                            </button>
                            <button onclick="navigateTo('MAINTENANCE')" class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all text-left">
                                <i data-lucide="settings" class="w-8 h-8 mb-2"></i>
                                <div class="font-bold">Maintenance</div>
                                <div class="text-xs text-green-100">Service expert</div>
                            </button>
                            <button onclick="navigateTo('NETWORK')" class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all text-left">
                                <i data-lucide="network" class="w-8 h-8 mb-2"></i>
                                <div class="font-bold">Réseau</div>
                                <div class="text-xs text-blue-100">500+ ateliers</div>
                            </button>
                        </div>
                    </section>

                    <!-- Industries -->
                    <section>
                        <h2 class="text-lg font-black text-slate-900 mb-3 px-1">Industries</h2>
                        <div class="grid grid-cols-3 gap-3">
                            ${INDUSTRIES_DATA.map(industry => `
                                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center justify-center gap-2 hover:border-blue-200 hover:shadow-md transition-all cursor-pointer">
                                    <i data-lucide="${industry.icon}" class="w-6 h-6 text-slate-700"></i>
                                    <span class="text-xs font-bold text-slate-600 text-center">${industry.title}</span>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                </div>
            `;
        }

        function renderQuotePage() {
            return `
                <div class="p-4 space-y-6 animate-slide-up">
                    <div class="flex items-center justify-between">
                        <h1 class="text-2xl font-black text-slate-900">Nouveau Devis</h1>
                        <button onclick="toggleChat()" class="text-sm font-bold text-[#005f9e] flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors">
                            <i data-lucide="message-circle" class="w-4 h-4"></i> Ingénieur
                        </button>
                    </div>

                    <!-- Upload Zone -->
                    <div id="upload-zone" onclick="handleUpload()" class="bg-white rounded-2xl border-2 border-dashed ${AppState.uploadState.status === 'idle' ? 'border-slate-300 hover:border-blue-400' : 'border-blue-500 bg-blue-50'} cursor-pointer transition-all relative ${AppState.uploadState.status === 'idle' ? 'h-64' : 'h-96'} flex flex-col items-center justify-center">
                        ${AppState.uploadState.status === 'idle' ? `
                            <i data-lucide="upload-cloud" class="w-12 h-12 text-blue-500 mb-4"></i>
                            <span class="font-bold text-slate-700">Glissez votre fichier 3D</span>
                            <span class="text-xs text-slate-400 mt-2">STEP, STL, XT</span>
                        ` : ''}
                        
                        ${AppState.uploadState.status === 'uploading' || AppState.uploadState.status === 'analyzing' ? `
                            <div class="flex flex-col items-center w-full px-10">
                                <i data-lucide="loader-2" class="w-8 h-8 text-blue-600 animate-spin mb-4"></i>
                                <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                                    <div class="progress-bar bg-blue-600 h-full transition-all duration-300" style="width: ${AppState.uploadState.progress}%"></div>
                                </div>
                                <span class="text-xs font-bold text-slate-500 mt-2 uppercase tracking-wider">${AppState.uploadState.status}</span>
                            </div>
                        ` : ''}
                        
                        ${AppState.uploadState.status === 'complete' ? `
                            <div id="canvas-container" class="w-full h-full rounded-xl overflow-hidden"></div>
                            ${AppState.uploadState.geoData ? `
                                <div class="absolute bottom-2 left-2 bg-white/95 backdrop-blur-sm px-3 py-2 rounded-lg text-xs font-bold text-slate-700 shadow-lg flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="ruler" class="w-3 h-3 text-blue-500"></i> ${AppState.uploadState.geoData.dimensions}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="box" class="w-3 h-3 text-blue-500"></i> ${Math.round(AppState.uploadState.geoData.volume)} cm³
                                    </div>
                                </div>
                            ` : ''}
                        ` : ''}
                    </div>

                    <!-- DFM Analysis -->
                    ${AppState.uploadState.status === 'complete' ? `
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                    <i data-lucide="cpu" class="w-5 h-5 text-blue-600"></i>
                                    Analyse DFM (IA)
                                </h3>
                                ${AppState.dfmState.status === 'analyzing' ? `<i data-lucide="loader-2" class="w-4 h-4 animate-spin text-blue-500"></i>` : ''}
                                ${AppState.dfmState.status === 'complete' ? `<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded">Terminé</span>` : ''}
                            </div>

                            <div class="p-4">
                                ${AppState.dfmState.status === 'analyzing' ? `
                                    <div class="space-y-4">
                                        <div class="space-y-2">
                                            <div class="flex justify-between text-xs font-medium text-slate-600">
                                                <span>Vérification des parois...</span>
                                                <span>35%</span>
                                            </div>
                                            <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="progress-bar h-full bg-blue-500" style="width: 35%"></div>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex justify-between text-xs font-medium text-slate-600">
                                                <span>Analyse des perçages...</span>
                                                <span>60%</span>
                                            </div>
                                            <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="progress-bar h-full bg-blue-500" style="width: 60%"></div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}

                                ${AppState.dfmState.status === 'complete' && AppState.dfmState.report ? `
                                    <div class="space-y-6">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-4">
                                                <div class="relative w-16 h-16 flex items-center justify-center">
                                                    <svg class="w-full h-full transform -rotate-90">
                                                        <circle cx="32" cy="32" r="28" stroke="#f1f5f9" stroke-width="6" fill="none" />
                                                        <circle cx="32" cy="32" r="28" stroke="${AppState.dfmState.report.score > 80 ? '#22c55e' : AppState.dfmState.report.score > 50 ? '#eab308' : '#ef4444'}" stroke-width="6" fill="none" stroke-dasharray="175" stroke-dashoffset="${175 - (175 * AppState.dfmState.report.score) / 100}" stroke-linecap="round" />
                                                    </svg>
                                                    <span class="absolute text-sm font-bold text-slate-700">${AppState.dfmState.report.score}%</span>
                                                </div>
                                                <div>
                                                    <div class="text-sm font-bold text-slate-900">Manufacturabilité</div>
                                                    <div class="text-xs text-slate-500">Score de faisabilité IA</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="space-y-2">
                                            ${AppState.dfmState.report.alerts.map(alert => `
                                                <div class="flex items-start gap-3 p-3 rounded-lg border ${alert.type === 'warning' ? 'bg-amber-50 border-amber-100 text-amber-800' :
                    alert.type === 'success' ? 'bg-green-50 border-green-100 text-green-800' :
                        'bg-blue-50 border-blue-100 text-blue-800'
                }">
                                                    <i data-lucide="${alert.icon}" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                                                    <span class="text-xs font-medium">${alert.message}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Config & Pricing -->
                    ${AppState.uploadState.geoData ? `
                        <div class="space-y-4">
                            <!-- Technical Data -->
                            <div class="bg-slate-900 text-white rounded-xl p-4 shadow-lg">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <i data-lucide="activity" class="w-4 h-4"></i> Analyse Géométrique
                                </h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-xs text-slate-400">Complexité</div>
                                        <div class="font-bold ${AppState.uploadState.geoData.complexity === 'High' ? 'text-red-400' :
                        AppState.uploadState.geoData.complexity === 'Medium' ? 'text-amber-400' : 'text-green-400'
                    }">
                                            ${AppState.uploadState.geoData.complexity} (${AppState.uploadState.geoData.vertexCount} pts)
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-slate-400">Temps Est.</div>
                                        <div class="font-bold text-blue-300 flex items-center gap-1">
                                            <i data-lucide="timer" class="w-4 h-4"></i> 
                                            ${AppState.price.breakdown.time ? `${Math.floor(AppState.price.breakdown.time / 60)}h ${Math.round(AppState.price.breakdown.time % 60)}m` : '--'}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Config Form -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 space-y-4">
                                
                                <!-- Process & Material -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-xs font-bold text-slate-700 uppercase">Procédé</label>
                                        <select onchange="updateConfig('process', this.value)" class="block w-full px-3 py-2 text-sm font-bold text-slate-900 border border-slate-200 rounded-lg bg-slate-50">
                                            <option ${AppState.config.process === 'Fraisage CNC' ? 'selected' : ''}>Fraisage CNC</option>
                                            <option ${AppState.config.process === 'Tournage CNC' ? 'selected' : ''}>Tournage CNC</option>
                                            <option ${AppState.config.process === 'Impression 3D' ? 'selected' : ''}>Impression 3D</option>
                                        </select>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-bold text-slate-700 uppercase">Matière</label>
                                        <select onchange="updateConfig('material', this.value)" class="block w-full px-3 py-2 text-sm font-bold text-slate-900 border border-slate-200 rounded-lg bg-slate-50">
                                            <option ${AppState.config.material === 'Aluminium 6061-T6' ? 'selected' : ''}>Aluminium 6061-T6</option>
                                            <option ${AppState.config.material === 'Aluminium 7075-T6' ? 'selected' : ''}>Aluminium 7075-T6</option>
                                            <option ${AppState.config.material === 'Acier Inoxydable 304L' ? 'selected' : ''}>Acier Inoxydable 304L</option>
                                            <option ${AppState.config.material === 'Acier Inoxydable 316L' ? 'selected' : ''}>Acier Inoxydable 316L</option>
                                            <option ${AppState.config.material === 'PEEK' ? 'selected' : ''}>PEEK</option>
                                            <option ${AppState.config.material === 'Delrin (Acétal)' ? 'selected' : ''}>Delrin (Acétal)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Finish & Tolerance -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-xs font-bold text-slate-700 uppercase">Finition</label>
                                        <select onchange="updateConfig('finish', this.value)" class="block w-full px-3 py-2 text-sm font-medium text-slate-900 border border-slate-200 rounded-lg bg-slate-50">
                                            <option ${AppState.config.finish === "Brut d'usinage (Standard)" ? 'selected' : ''}>Brut d'usinage (Standard)</option>
                                            <option ${AppState.config.finish === "Anodisation Incolore (Type II)" ? 'selected' : ''}>Anodisation Incolore (Type II)</option>
                                            <option ${AppState.config.finish === "Anodisation Dure (Type III)" ? 'selected' : ''}>Anodisation Dure (Type III)</option>
                                            <option ${AppState.config.finish === "Microbillage (Sablage)" ? 'selected' : ''}>Microbillage (Sablage)</option>
                                            <option ${AppState.config.finish === "Peinture Poudre (Epoxy)" ? 'selected' : ''}>Peinture Poudre (Epoxy)</option>
                                            <option ${AppState.config.finish === "Polissage Miroir" ? 'selected' : ''}>Polissage Miroir</option>
                                        </select>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-bold text-slate-700 uppercase">Tolérance</label>
                                        <select onchange="updateConfig('tolerance', this.value)" class="block w-full px-3 py-2 text-sm font-medium text-slate-900 border border-slate-200 rounded-lg bg-slate-50">
                                            <option ${AppState.config.tolerance === "Standard (ISO 2768-m)" ? 'selected' : ''}>Standard (ISO 2768-m)</option>
                                            <option ${AppState.config.tolerance === "Précision (ISO 2768-f)" ? 'selected' : ''}>Précision (ISO 2768-f)</option>
                                            <option ${AppState.config.tolerance === "Haute Précision (+/- 0.01mm)" ? 'selected' : ''}>Haute Précision (+/- 0.01mm)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Certificates & Options -->
                                <div class="space-y-2 pt-2">
                                    <label class="text-xs font-bold text-slate-700 uppercase">Certifications & Qualité</label>
                                    <div class="flex flex-wrap gap-2">
                                        <label class="flex items-center gap-2 px-3 py-2 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 ${AppState.config.certificates.includes('Certificat Matière (3.1)') ? 'bg-blue-50 border-blue-200' : ''}">
                                            <input type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" 
                                                ${AppState.config.certificates.includes('Certificat Matière (3.1)') ? 'checked' : ''}
                                                onchange="const certs = AppState.config.certificates; if(this.checked) certs.push('Certificat Matière (3.1)'); else { const idx = certs.indexOf('Certificat Matière (3.1)'); if(idx > -1) certs.splice(idx, 1); } updateConfig('certificates', certs);">
                                            <span class="text-xs font-medium">Certificat Matière</span>
                                        </label>
                                        <label class="flex items-center gap-2 px-3 py-2 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 ${AppState.config.certificates.includes('Rapport de Contrôle') ? 'bg-blue-50 border-blue-200' : ''}">
                                            <input type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                                                ${AppState.config.certificates.includes('Rapport de Contrôle') ? 'checked' : ''}
                                                onchange="const certs = AppState.config.certificates; if(this.checked) certs.push('Rapport de Contrôle'); else { const idx = certs.indexOf('Rapport de Contrôle'); if(idx > -1) certs.splice(idx, 1); } updateConfig('certificates', certs);">
                                            <span class="text-xs font-medium">Rapport de Contrôle</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Delivery Options -->
                                <div class="space-y-2 pt-2">
                                    <label class="text-xs font-bold text-slate-700 uppercase">Délais de Livraison</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div onclick="updateConfig('delivery', 'Eco (J+15)')" class="cursor-pointer border rounded-lg p-2 text-center transition-all ${AppState.config.delivery === 'Eco (J+15)' ? 'border-green-500 bg-green-50 ring-1 ring-green-500' : 'border-slate-200 hover:bg-slate-50'}">
                                            <div class="text-xs font-bold text-slate-500">Éco</div>
                                            <div class="font-black text-slate-800">J+15</div>
                                        </div>
                                        <div onclick="updateConfig('delivery', 'Standard (J+7)')" class="cursor-pointer border rounded-lg p-2 text-center transition-all ${AppState.config.delivery === 'Standard (J+7)' ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-slate-200 hover:bg-slate-50'}">
                                            <div class="text-xs font-bold text-blue-600">Standard</div>
                                            <div class="font-black text-slate-800">J+7</div>
                                        </div>
                                        <div onclick="updateConfig('delivery', 'Express (J+3)')" class="cursor-pointer border rounded-lg p-2 text-center transition-all ${AppState.config.delivery === 'Express (J+3)' ? 'border-purple-500 bg-purple-50 ring-1 ring-purple-500' : 'border-slate-200 hover:bg-slate-50'}">
                                            <div class="text-xs font-bold text-purple-600">Express</div>
                                            <div class="font-black text-slate-800">J+3</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quantity & Price -->
                                <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                                    <div class="flex items-center gap-3">
                                        <button onclick="updateConfig('quantity', Math.max(1, AppState.config.quantity - 1))" class="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
                                            <i data-lucide="minus" class="w-4 h-4"></i>
                                        </button>
                                        <span class="font-bold text-lg w-8 text-center">${AppState.config.quantity}</span>
                                        <button onclick="updateConfig('quantity', AppState.config.quantity + 1)" class="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
                                            <i data-lucide="plus" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-slate-400 font-bold">Total HT</div>
                                        <div class="text-2xl font-black text-[#005f9e]">${AppState.price.total.toLocaleString('fr-FR')} DA</div>
                                        <div class="text-[10px] text-slate-400">${AppState.price.unit.toLocaleString('fr-FR')} DA / pièce</div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="flex gap-3">
                                    <button onclick="window.print()" class="flex-1 bg-white text-slate-700 border border-slate-200 font-bold py-3 rounded-lg hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                                        <i data-lucide="printer" class="w-4 h-4"></i> Devis PDF
                                    </button>
                                    <button onclick="addToCart()" class="flex-[2] gradient-primary text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                                        Ajouter au panier <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderServiceDetailPage() {
            const service = AppState.activeData;
            if (!service) return '<div class="p-4">Service non trouvé</div>';

            return `
                <div class="min-h-screen bg-white animate-slide-in-right pb-24">
                    <div class="sticky top-0 bg-white/80 backdrop-blur-md border-b border-slate-100 p-4 flex items-center gap-4 z-30">
                        <button onclick="navigateTo('HOME')" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                        <div class="text-sm font-medium text-slate-400">
                            Services / <span class="text-slate-900">${service.title}</span>
                        </div>
                    </div>

                    <div class="p-6 space-y-10">
                        <!-- Hero -->
                        <div class="space-y-4 text-center">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-50 to-blue-100 rounded-3xl flex items-center justify-center text-blue-600 mx-auto mb-4">
                                <i data-lucide="${service.icon}" class="w-10 h-10"></i>
                            </div>
                            <h1 class="text-3xl font-black text-slate-900">${service.title}</h1>
                            <p class="text-lg text-slate-600 leading-relaxed">${service.subtitle}</p>
                            <button onclick="navigateTo('QUOTE', service)" class="gradient-primary text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-all">
                                Obtenir un devis ${service.title}
                            </button>
                        </div>

                        <!-- How it Works -->
                        <section>
                            <h2 class="text-xl font-bold text-slate-900 mb-6 text-center">Comment ça marche ?</h2>
                            <div class="grid grid-cols-1 gap-6">
                                ${service.steps.map((step, idx) => `
                                    <div class="flex items-start gap-4">
                                        <div class="bg-slate-100 p-3 rounded-xl text-slate-600 mt-1">
                                            <i data-lucide="${step.icon}" class="w-6 h-6"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-slate-900 text-lg">${step.title}</h3>
                                            <p class="text-slate-600 text-sm leading-relaxed">${step.desc}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>

                        <!-- Materials -->
                        <section class="bg-slate-50 -mx-6 p-6">
                            <h2 class="text-xl font-bold text-slate-900 mb-4">Matériaux Disponibles</h2>
                            <div class="flex flex-wrap gap-2">
                                ${service.materials.map(mat => `
                                    <span class="bg-white border border-slate-200 px-3 py-1.5 rounded-full text-sm font-medium text-slate-700 shadow-sm">
                                        ${mat}
                                    </span>
                                `).join('')}
                            </div>
                        </section>

                        <!-- Gallery -->
                        <section>
                            <h2 class="text-xl font-bold text-slate-900 mb-4">Galerie</h2>
                            <div class="grid grid-cols-3 gap-2">
                                ${service.gallery.map(color => `
                                    <div class="aspect-square rounded-xl ${color} shadow-inner"></div>
                                `).join('')}
                            </div>
                        </section>

                        <!-- Description -->
                        <section>
                            <h2 class="text-xl font-bold text-slate-900 mb-2">À propos</h2>
                            <p class="text-slate-600 leading-relaxed">${service.longDescription}</p>
                        </section>
                    </div>

                    <!-- Sticky CTA -->
                    <div class="fixed bottom-20 left-4 right-4 z-30">
                        <button onclick="navigateTo('QUOTE', service)" class="w-full gradient-primary text-white font-bold py-4 rounded-xl shadow-xl hover:shadow-2xl transition-all flex items-center justify-center gap-2">
                            Devis pour ${service.title} <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTrainingPage() {
            return `
                <div class="p-4 space-y-6 animate-slide-up">
                    <div class="text-center space-y-2">
                        <h1 class="text-2xl font-black text-slate-900">Formations CNC</h1>
                        <p class="text-slate-600 text-sm">Développez vos compétences avec nos experts</p>
                    </div>

                    <!-- Formations Programmées -->
                    ${scheduledTrainings.length > 0 ? `
                        <div class="space-y-3">
                            <h2 class="text-lg font-black text-slate-900 px-1 flex items-center gap-2">
                                <i data-lucide="calendar" class="w-5 h-5 text-[#005f9e]"></i>
                                Formations Programmées (${scheduledTrainings.length})
                            </h2>
                            ${scheduledTrainings.map(training => `
                                <div class="bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all overflow-hidden">
                                    <div class="p-5">
                                        <div class="flex items-start gap-4">
                                            <div class="${training.color} text-white p-3 rounded-xl">
                                                <i data-lucide="${training.icon}" class="w-6 h-6"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-bold text-slate-900 text-lg">${training.title}</h3>
                                                <p class="text-sm text-slate-600 mt-1">${training.description}</p>
                                                
                                                <!-- Formation Details -->
                                                <div class="grid grid-cols-2 gap-3 mt-3">
                                                    <div class="flex items-center gap-2 text-xs text-slate-600">
                                                        <i data-lucide="user" class="w-4 h-4 text-blue-500"></i>
                                                        <span>${training.instructor}</span>
                                                    </div>
                                                    <div class="flex items-center gap-2 text-xs text-slate-600">
                                                        <i data-lucide="clock" class="w-4 h-4 text-blue-500"></i>
                                                        <span>${training.duration}</span>
                                                    </div>
                                                    <div class="flex items-center gap-2 text-xs text-slate-600">
                                                        <i data-lucide="calendar" class="w-4 h-4 text-blue-500"></i>
                                                        <span>${new Date(training.date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' })}</span>
                                                    </div>
                                                    <div class="flex items-center gap-2 text-xs text-slate-600">
                                                        <i data-lucide="clock" class="w-4 h-4 text-blue-500"></i>
                                                        <span>${training.time}</span>
                                                    </div>
                                                    <div class="flex items-center gap-2 text-xs text-slate-600">
                                                        <i data-lucide="map-pin" class="w-4 h-4 text-blue-500"></i>
                                                        <span class="line-clamp-1">${training.location}</span>
                                                    </div>
                                                    <div class="flex items-center gap-2 text-xs font-bold ${training.seats - training.booked <= 5 ? 'text-red-600' : 'text-green-600'}">
                                                        <i data-lucide="users" class="w-4 h-4"></i>
                                                        <span>${training.seats - training.booked} places restantes</span>
                                                    </div>
                                                </div>

                                                <!-- Level Badge -->
                                                <div class="mt-3">
                                                    <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">${training.level}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Price & Booking -->
                                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100">
                                            <div>
                                                <div class="text-xs text-slate-400 font-bold">Prix</div>
                                                <div class="text-2xl font-black text-[#005f9e]">${training.price.toLocaleString('fr-FR')} DA</div>
                                            </div>
                                            <button onclick="openBookingModal('${training.id}')" class="gradient-primary text-white font-bold py-3 px-6 rounded-lg hover:shadow-lg transition-all inline-flex items-center gap-2">
                                                <i data-lucide="calendar-check" class="w-4 h-4"></i>
                                                <span>Réserver</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Formations en Ligne Gratuites -->
                    <div class="space-y-3">
                        <h2 class="text-lg font-black text-slate-900 px-1 flex items-center gap-2">
                            <i data-lucide="globe" class="w-5 h-5 text-green-600"></i>
                            Formations en Ligne Gratuites
                        </h2>
                        ${TRAINING_DATA.map(training => `
                            <div class="bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all overflow-hidden">
                                <div class="p-5">
                                    <div class="flex items-start gap-4">
                                        <div class="${training.color} text-white p-3 rounded-xl">
                                            <i data-lucide="${training.icon}" class="w-6 h-6"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-start justify-between gap-2">
                                                <h3 class="font-bold text-slate-900 text-lg">${training.title}</h3>
                                                ${training.isFree ? '<span class="text-xs font-black bg-green-500 text-white px-2 py-1 rounded-full">GRATUIT</span>' : ''}
                                            </div>
                                            <p class="text-sm text-slate-600 mt-1">${training.description}</p>
                                            <div class="flex flex-wrap gap-2 mt-3">
                                                <span class="text-xs font-bold bg-slate-100 text-slate-700 px-2 py-1 rounded">${training.duration}</span>
                                                <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">${training.level}</span>
                                            </div>
                                            <p class="text-xs text-slate-500 mt-2 leading-relaxed">${training.details}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100">
                                        <div class="text-xl font-black text-green-600">Formation 100% Gratuite</div>
                                        <a href="${training.url}" target="_blank" rel="noopener noreferrer" class="gradient-primary text-white font-bold py-2 px-4 rounded-lg hover:shadow-lg transition-all inline-flex items-center gap-2">
                                            <span>Voir la formation</span>
                                            <i data-lucide="external-link" class="w-4 h-4"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Contact CTA -->
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 text-center">
                        <h3 class="font-bold text-lg mb-2">Formation sur mesure ?</h3>
                        <p class="text-sm text-blue-100 mb-4">Contactez-nous pour un programme personnalisé</p>
                        <button class="bg-white text-blue-600 font-bold py-2 px-6 rounded-lg hover:shadow-lg transition-all">
                            Nous contacter
                        </button>
                    </div>
                </div>
            `;
        }

        // Open booking modal for scheduled training
        function openBookingModal(trainingId) {
            const training = scheduledTrainings.find(t => t.id === trainingId);
            if (!training) return;

            const modalHTML = `
                <div id="booking-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeBookingModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-scale-in">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-black text-slate-900">Réserver une place</h2>
                            <button onclick="closeBookingModal()" class="p-2 hover:bg-slate-100 rounded-full">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-100">
                            <div class="font-bold text-slate-900">${training.title}</div>
                            <div class="text-sm text-slate-600 mt-1">${new Date(training.date).toLocaleDateString('fr-FR')} • ${training.time}</div>
                            <div class="text-lg font-black text-[#005f9e] mt-2">${training.price.toLocaleString('fr-FR')} DA</div>
                        </div>

                        <form onsubmit="event.preventDefault(); submitBooking('${trainingId}');" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Nom Complet</label>
                                <input id="booking-name" type="text" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ahmed Benali">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Email</label>
                                <input id="booking-email" type="email" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ahmed@email.com">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Téléphone</label>
                                <input id="booking-phone" type="tel" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="+213 555 123 456">
                            </div>

                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 uppercase block">Moyen de Paiement</label>
                                <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                    <input type="radio" name="payment" value="ccp" checked class="w-4 h-4 text-blue-600">
                                    <div class="flex-1">
                                        <div class="font-bold text-sm">CCP</div>
                                        <div class="text-xs text-slate-500">Chèque postal</div>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                    <input type="radio" name="payment" value="baridi" class="w-4 h-4 text-blue-600">
                                    <div class="flex-1">
                                        <div class="font-bold text-sm">Baridi Mob</div>
                                        <div class="text-xs text-slate-500">Paiement mobile</div>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                    <input type="radio" name="payment" value="card" class="w-4 h-4 text-blue-600">
                                    <div class="flex-1">
                                        <div class="font-bold text-sm">Carte Bancaire</div>
                                        <div class="text-xs text-slate-500">Visa / Mastercard</div>
                                    </div>
                                </label>
                            </div>

                            <button type="submit" class="w-full gradient-primary text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all">
                                Confirmer la réservation
                            </button>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function closeBookingModal() {
            const modal = document.getElementById('booking-modal');
            if (modal) modal.remove();
        }

        function submitBooking(trainingId) {
            const name = document.getElementById('booking-name').value;
            const email = document.getElementById('booking-email').value;
            const phone = document.getElementById('booking-phone').value;
            const payment = document.querySelector('input[name="payment"]:checked').value;

            const training = scheduledTrainings.find(t => t.id === trainingId);
            if (training && training.booked < training.seats) {
                training.booked++;
                alert(`✅ Réservation confirmée !\n\nFormation: ${training.title}\nNom: ${name}\nPaiement: ${payment.toUpperCase()}\n\nVous recevrez une confirmation par email à ${email}`);
                closeBookingModal();
                render();
            } else {
                alert('❌ Désolé, il n\'y a plus de places disponibles.');
            }
        }

        function renderPartsPage() {
            return `
                <div class="p-4 space-y-6 animate-slide-up">
                    <div class="text-center space-y-2">
                        <h1 class="text-2xl font-black text-slate-900">Pièces & Consommables</h1>
                        <p class="text-slate-600 text-sm">Boutique en ligne pour machines CNC</p>
                    </div>

                    <!-- Category Filter -->
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                        <button class="px-4 py-2 bg-[#005f9e] text-white rounded-full text-sm font-bold whitespace-nowrap">Tous</button>
                        <button class="px-4 py-2 bg-slate-100 text-slate-700 rounded-full text-sm font-bold whitespace-nowrap hover:bg-slate-200">Broches</button>
                        <button class="px-4 py-2 bg-slate-100 text-slate-700 rounded-full text-sm font-bold whitespace-nowrap hover:bg-slate-200">Outils</button>
                        <button class="px-4 py-2 bg-slate-100 text-slate-700 rounded-full text-sm font-bold whitespace-nowrap hover:bg-slate-200">Consommables</button>
                    </div>

                    <!-- Parts Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        ${PARTS_DATA.map(part => `
                            <div class="bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all overflow-hidden">
                                <div class="${part.image} h-32 flex items-center justify-center text-white">
                                    <i data-lucide="package" class="w-12 h-12 opacity-50"></i>
                                </div>
                                <div class="p-3">
                                    <div class="text-xs font-bold text-slate-400 uppercase">${part.category}</div>
                                    <h3 class="font-bold text-slate-900 text-sm mt-1 line-clamp-2">${part.name}</h3>
                                    <p class="text-xs text-slate-500 mt-1 line-clamp-2">${part.description}</p>
                                    <div class="flex items-center justify-between mt-3">
                                        <div class="text-lg font-black text-[#005f9e]">${part.price.toLocaleString('fr-FR')} DA</div>
                                        <span class="text-xs font-bold ${part.stock === 'En stock' ? 'text-green-600' : 'text-orange-600'}">${part.stock}</span>
                                    </div>
                                    <button class="w-full gradient-primary text-white font-bold py-2 rounded-lg mt-3 hover:shadow-lg transition-all text-sm">
                                        Ajouter
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderMaintenancePage() {
            return `
                <div class="p-4 space-y-6 animate-slide-up">
                    <div class="text-center space-y-2">
                        <h1 class="text-2xl font-black text-slate-900">Maintenance & Entretien</h1>
                        <p class="text-slate-600 text-sm">Service expert pour vos machines CNC</p>
                    </div>

                    <!-- Hero Card -->
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-2xl p-6 text-center">
                        <i data-lucide="wrench" class="w-16 h-16 mx-auto mb-4 opacity-80"></i>
                        <h2 class="text-xl font-bold mb-2">Contrat de Maintenance</h2>
                        <p class="text-sm text-green-100 mb-4">Garantissez la disponibilité de vos équipements</p>
                        <button class="bg-white text-green-600 font-bold py-3 px-6 rounded-lg hover:shadow-lg transition-all">
                            Demander un devis
                        </button>
                    </div>

                    <!-- Services -->
                    <div class="space-y-3">
                        <div class="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
                            <div class="flex items-start gap-4">
                                <div class="bg-blue-100 p-3 rounded-xl text-blue-600">
                                    <i data-lucide="calendar" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-slate-900">Maintenance Préventive</h3>
                                    <p class="text-sm text-slate-600 mt-1">Visites programmées pour éviter les pannes</p>
                                    <ul class="text-xs text-slate-500 mt-2 space-y-1">
                                        <li>• Inspection complète</li>
                                        <li>• Lubrification & nettoyage</li>
                                        <li>• Calibration & alignement</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
                            <div class="flex items-start gap-4">
                                <div class="bg-red-100 p-3 rounded-xl text-red-600">
                                    <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-slate-900">Dépannage Urgent</h3>
                                    <p class="text-sm text-slate-600 mt-1">Intervention rapide 24/7</p>
                                    <ul class="text-xs text-slate-500 mt-2 space-y-1">
                                        <li>• Diagnostic à distance</li>
                                        <li>• Technicien sur site J+1</li>
                                        <li>• Pièces de rechange en stock</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
                            <div class="flex items-start gap-4">
                                <div class="bg-purple-100 p-3 rounded-xl text-purple-600">
                                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-slate-900">Retrofit & Modernisation</h3>
                                    <p class="text-sm text-slate-600 mt-1">Mise à niveau de vos machines</p>
                                    <ul class="text-xs text-slate-500 mt-2 space-y-1">
                                        <li>• Contrôleurs CNC nouvelle génération</li>
                                        <li>• Systèmes de mesure 3D</li>
                                        <li>• Automatisation & robotique</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Form -->
                    <div class="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
                        <h3 class="font-bold text-slate-900 mb-4">Demande d'intervention</h3>
                        <div class="space-y-3">
                            <input type="text" placeholder="Votre nom" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <input type="email" placeholder="Email" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <input type="tel" placeholder="Téléphone" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <textarea placeholder="Décrivez votre problème..." rows="3" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                            <button class="w-full gradient-primary text-white font-bold py-3 rounded-lg hover:shadow-lg transition-all">
                                Envoyer la demande
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNetworkPage() {
            return `
                <div class="p-4 flex flex-col items-center justify-center min-h-[60vh] text-center space-y-4">
                    <div class="bg-slate-100 p-6 rounded-full">
                        <i data-lucide="network" class="w-12 h-12 text-slate-400"></i>
                    </div>
                    <h2 class="text-xl font-bold text-slate-900">Réseau de Partenaires</h2>
                    <p class="text-slate-500 max-w-xs">Accédez prochainement à la carte interactive de nos 500+ ateliers partenaires en Algérie.</p>
                    <div class="grid grid-cols-3 gap-4 mt-6">
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <div class="text-2xl font-black text-[#005f9e]">500+</div>
                            <div class="text-xs text-slate-500">Ateliers</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <div class="text-2xl font-black text-[#005f9e]">48</div>
                            <div class="text-xs text-slate-500">Wilayas</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <div class="text-2xl font-black text-[#005f9e]">24/7</div>
                            <div class="text-xs text-slate-500">Support</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProfilePage() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 animate-slide-up pb-24">
                    <div class="gradient-primary text-white p-8 pb-16 rounded-b-[2.5rem] shadow-lg">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-white text-2xl font-bold">JD</div>
                            <div>
                                <h1 class="text-2xl font-bold">John Doe</h1>
                                <p class="text-blue-200">john.doe@example.com</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="flex-1 bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                                <div class="text-2xl font-bold">${AppState.orders.length}</div>
                                <div class="text-xs text-blue-200">Commandes</div>
                            </div>
                            <div class="flex-1 bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                                <div class="text-2xl font-bold">0</div>
                                <div class="text-xs text-blue-200">En attente</div>
                            </div>
                        </div>
                    </div>

                    <div class="px-4 -mt-8 space-y-6">
                        <!-- Menu -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <button class="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition-colors border-b border-slate-50">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="user" class="w-5 h-5 text-slate-700"></i>
                                    <span class="font-medium text-slate-700">Mes Coordonnées</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                            </button>
                            <button class="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition-colors border-b border-slate-50">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="history" class="w-5 h-5 text-slate-700"></i>
                                    <span class="font-medium text-slate-700">Historique des Devis</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                            </button>
                            <button class="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition-colors">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="settings" class="w-5 h-5 text-slate-700"></i>
                                    <span class="font-medium text-slate-700">Paramètres</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                            </button>
                        </div>

                        <!-- Recent Orders -->
                        <div>
                            <h3 class="font-bold text-slate-900 mb-3 px-2">Commandes Récentes</h3>
                            <div class="space-y-3">
                                ${AppState.orders.slice(0, 3).map(order => `
                                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center">
                                        <div>
                                            <div class="font-bold text-slate-800 text-sm">${order.file}</div>
                                            <div class="text-xs text-slate-500">${order.id} • ${order.date}</div>
                                        </div>
                                        <span class="text-[10px] font-bold px-2 py-1 rounded-full ${order.status === 'WAITING' ? 'bg-blue-100 text-blue-700' :
                    order.status === 'MACHINING' ? 'bg-amber-100 text-amber-700' :
                        'bg-green-100 text-green-700'
                }">
                                            ${order.status}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== FACTORY VIEW ====================
        function renderFactoryView() {
            return `
                <div class="min-h-screen bg-slate-50 animate-fade-in">
                    ${renderHeader()}
                    
                    <div class="p-4 space-y-6 pb-24">
                        <div class="gradient-primary text-white rounded-xl p-6">
                            <h1 class="text-2xl font-bold mb-4">Tableau de Bord Usine</h1>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                                    <div class="text-2xl font-bold">${AppState.orders.length}</div>
                                    <div class="text-xs text-blue-200">Commandes</div>
                                </div>
                                <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                                    <div class="text-2xl font-bold">${AppState.orders.filter(o => o.status === 'MACHINING').length}</div>
                                    <div class="text-xs text-blue-200">En cours</div>
                                </div>
                                <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                                    <div class="text-2xl font-bold">${AppState.orders.filter(o => o.status === 'QC').length}</div>
                                    <div class="text-xs text-blue-200">Contrôle</div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            ${AppState.orders.map(order => `
                                <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <div class="font-bold text-slate-900">${order.id}</div>
                                            <div class="text-sm text-slate-600">${order.client}</div>
                                        </div>
                                        <span class="text-xs font-bold px-2 py-1 rounded-full ${order.status === 'WAITING' ? 'bg-blue-100 text-blue-700' :
                    order.status === 'MACHINING' ? 'bg-amber-100 text-amber-700' :
                        'bg-green-100 text-green-700'
                }">
                                            ${order.status}
                                        </span>
                                    </div>
                                    <div class="text-sm text-slate-600 mb-2">${order.file}</div>
                                    <div class="text-xs text-slate-500 mb-3">
                                        ${order.config.material} • ${order.config.process} • Qté: ${order.config.quantity}
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <div class="text-lg font-bold text-[#005f9e]">${order.price.toLocaleString('fr-FR')} DA</div>
                                        <div class="flex gap-2">
                                            ${order.status === 'WAITING' ? `
                                                <button onclick="updateOrderStatus('${order.id}', 'MACHINING')" class="text-xs font-bold bg-amber-100 text-amber-700 px-3 py-1.5 rounded-lg hover:bg-amber-200">
                                                    Démarrer
                                                </button>
                                            ` : ''}
                                            ${order.status === 'MACHINING' ? `
                                                <button onclick="updateOrderStatus('${order.id}', 'QC')" class="text-xs font-bold bg-green-100 text-green-700 px-3 py-1.5 rounded-lg hover:bg-green-200">
                                                    Contrôle QC
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${renderBottomNav()}
                    ${renderFloatingChat()}
                    ${renderChatPanel()}
                </div>
            `;
        }

        function updateOrderStatus(orderId, newStatus) {
            const order = AppState.orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                render();
            }
        }

        // ==================== ADMIN FUNCTIONS ====================
        function assignOrderToWorkshop(orderId, workshopName) {
            const order = AppState.orders.find(o => o.id === orderId);
            if (order) {
                order.assignedWorkshop = workshopName;
                alert(`✅ Commande ${orderId} assignée à ${workshopName}`);
                render();
            }
        }

        function replyToMessage(messageId, replyText) {
            const message = AppState.supportMessages.find(m => m.id === messageId);
            if (message && replyText.trim()) {
                message.replies.push({
                    sender: 'admin',
                    text: replyText,
                    timestamp: new Date().toLocaleString('fr-FR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                });
                message.status = 'replied';
                alert('✅ Réponse envoyée au client');
                render();
            }
        }

        function markMessageAsRead(messageId) {
            const message = AppState.supportMessages.find(m => m.id === messageId);
            if (message) {
                message.status = 'replied';
                render();
            }
        }

        // ==================== ADMIN VIEW ====================
        function renderAdminView() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-red-50 to-slate-50 animate-fade-in">
                    ${renderHeader()}
                    
                    <div class="p-4 space-y-6 pb-24">
                        <!-- Admin Dashboard Header -->
                        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl p-6 shadow-lg">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-3 bg-white/20 rounded-full">
                                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-black">Interface Admin</h1>
                                    <p class="text-sm text-red-100">Gestion complète de CNC Connect Algérie</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-3">
                                <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                                    <div class="text-2xl font-bold">${AppState.orders.length}</div>
                                    <div class="text-xs text-red-100">Commandes</div>
                                </div>
                                <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                                    <div class="text-2xl font-bold">${AppState.supportMessages.filter(m => m.status === 'unread').length}</div>
                                    <div class="text-xs text-red-100">Messages</div>
                                </div>
                                <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                                    <div class="text-2xl font-bold">${AppState.workshops.length}</div>
                                    <div class="text-xs text-red-100">Ateliers</div>
                                </div>\n                            </div>
                        </div>

                        <!-- Quick Filters -->
                        <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                            <button onclick="AppState.activeData = {filter: 'messages'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'messages' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                💬 Messages Support
                            </button>
                            <button onclick="AppState.activeData = {filter: 'orders'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'orders' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                📦 Commandes
                            </button>
                            <button onclick="AppState.activeData = {filter: 'workshops'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'workshops' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                🏭 Ateliers
                            </button>
                            <button onclick="AppState.activeData = {filter: 'trainings'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'trainings' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                🎓 Formations
                            </button>
                            <button onclick="AppState.activeData = {filter: 'stock'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'stock' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                📦 Stock
                            </button>
                            <button onclick="AppState.activeData = {filter: 'clients'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'clients' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                🧾 Clients
                            </button>
                            <button onclick="AppState.activeData = {filter: 'team'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'team' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                👥 Équipe
                            </button>
                            <button onclick="AppState.activeData = {filter: 'machines'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'machines' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                🖥️ Machines
                            </button>
                            <button onclick="AppState.activeData = {filter: 'quality'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'quality' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                ✅ Qualité
                            </button>
                            <button onclick="AppState.activeData = {filter: 'expenses'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'expenses' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                💰 Dépenses
                            </button>
                            <button onclick="AppState.activeData = {filter: 'analytics'}; render();" class="px-4 py-2 ${AppState.activeData?.filter === 'analytics' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border border-slate-200'} rounded-full text-sm font-bold whitespace-nowrap shadow-sm hover:shadow-md transition-all">
                                📊 Analytics
                            </button>
                        </div>

                        ${renderAdminContent()}
                    </div>

                    ${renderBottomNav()}
                </div>
            `;
        }

        function renderAdminContent() {
            const filter = AppState.activeData?.filter || 'messages';

            if (filter === 'messages') return renderAdminMessages();
            if (filter === 'orders') return renderAdminOrders();
            if (filter === 'workshops') return renderAdminWorkshops();
            if (filter === 'trainings') return renderAdminTrainings();
            if (filter === 'stock') return renderAdminStock();
            if (filter === 'clients') return renderAdminClients();
            if (filter === 'team') return renderAdminTeam();
            if (filter === 'machines') return renderAdminMachines();
            if (filter === 'quality') return renderAdminQuality();
            if (filter === 'expenses') return renderAdminExpenses();
            if (filter === 'analytics') return renderAdminAnalytics();

            return renderAdminMessages();
        }

        // ==================== ADMIN TRAINING MANAGEMENT ====================
        function renderAdminTrainings() {
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h2 class="text-lg font-black text-slate-900">Gestion des Formations (${scheduledTrainings.length})</h2>
                        <button onclick="openCreateTrainingModal()" class="bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all inline-flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Créer Formation</span>
                        </button>
                    </div>
                    
                    ${scheduledTrainings.length === 0 ? `
                        <div class="bg-white rounded-xl border border-slate-200 p-12 text-center">
                            <i data-lucide="graduation-cap" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
                            <h3 class="text-lg font-bold text-slate-700 mb-2">Aucune formation programmée</h3>
                            <p class="text-sm text-slate-500 mb-4">Créez votre première formation pour commencer</p>
                            <button onclick="openCreateTrainingModal()" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors">
                                Créer une formation
                            </button>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${scheduledTrainings.map(training => `
                                <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                                    <div class="p-5">
                                        <div class="flex items-start gap-4 mb-4">
                                            <div class="${training.color} text-white p-3 rounded-xl">
                                                <i data-lucide="${training.icon}" class="w-6 h-6"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-bold text-slate-900 text-lg">${training.title}</h3>
                                                <p class="text-sm text-slate-600 mt-1">${training.description}</p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="openEditTrainingModal('${training.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Modifier">
                                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="deleteTraining('${training.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Supprimer">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-2 gap-3 p-3 bg-slate-50 rounded-lg">
                                            <div>
                                                <div class="text-xs text-slate-500">Date & Heure</div>
                                                <div class="text-sm font-bold text-slate-900">${new Date(training.date).toLocaleDateString('fr-FR')} à ${training.time}</div>
                                            </div>
                                            <div>
                                                <div class="text-xs text-slate-500">Durée</div>
                                                <div class="text-sm font-bold text-slate-900">${training.duration}</div>
                                            </div>
                                            <div>
                                                <div class="text-xs text-slate-500">Prix</div>
                                                <div class="text-sm font-bold text-green-600">${training.price.toLocaleString('fr-FR')} DA</div>
                                            </div>
                                            <div>
                                                <div class="text-xs text-slate-500">Places</div>
                                                <div class="text-sm font-bold ${training.seats - training.booked <= 5 ? 'text-red-600' : 'text-blue-600'}">${training.booked}/${training.seats}</div>
                                            </div>
                                            <div class="col-span-2">
                                                <div class="text-xs text-slate-500">Formateur</div>
                                                <div class="text-sm font-bold text-slate-900">${training.instructor}</div>
                                            </div>
                                            <div class="col-span-2">
                                                <div class="text-xs text-slate-500">Localisation</div>
                                                <div class="text-sm font-bold text-slate-900">${training.location}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function openCreateTrainingModal() {
            const modalHTML = `
                <div id="training-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeTrainingModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-scale-in">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-black text-slate-900">Créer une Formation</h2>
                            <button onclick="closeTrainingModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <form onsubmit="event.preventDefault(); createTraining();" class="p-6 space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Titre de la Formation</label>
                                <input id="training-title" type="text" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500 font-medium" placeholder="Ex: Programmation CNC Avancée">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Description</label>
                                <textarea id="training-description" required rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Description détaillée de la formation"></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Formateur</label>
                                    <input id="training-instructor" type="text" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Ex: Ing. Ahmed Benali">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Niveau</label>
                                    <select id="training-level" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="Débutant">Débutant</option>
                                        <option value="Intermédiaire">Intermédiaire</option>
                                        <option value="Avancé">Avancé</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Date</label>
                                    <input id="training-date" type="date" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Heure</label>
                                    <input id="training-time" type="time" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Durée</label>
                                    <input id="training-duration" type="text" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Ex: 3 jours">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Prix (DA)</label>
                                    <input id="training-price" type="number" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Ex: 45000">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Nombre de Places</label>
                                    <input id="training-seats" type="number" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Ex: 20">
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Localisation</label>
                                <input id="training-location" type="text" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Ex: Alger - Zone Industrielle Rouiba">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Icône</label>
                                    <select id="training-icon" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="code-2">Code (Programmation)</option>
                                        <option value="wrench">Wrench (Maintenance)</option>
                                        <option value="settings">Settings (Technique)</option>
                                        <option value="cpu">CPU (Technologie)</option>
                                        <option value="tool">Tool (Outillage)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Couleur</label>
                                    <select id="training-color" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="bg-blue-500">Bleu</option>
                                        <option value="bg-green-500">Vert</option>
                                        <option value="bg-purple-500">Violet</option>
                                        <option value="bg-red-500">Rouge</option>
                                        <option value="bg-orange-500">Orange</option>
                                        <option value="bg-cyan-500">Cyan</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="closeTrainingModal()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-lg hover:bg-slate-200 transition-colors">
                                    Annuler
                                </button>
                                <button type="submit" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all">
                                    Créer la Formation
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function openEditTrainingModal(trainingId) {
            const training = scheduledTrainings.find(t => t.id === trainingId);
            if (!training) return;

            const modalHTML = `
                <div id="training-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeTrainingModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-scale-in">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-black text-slate-900">Modifier la Formation</h2>
                            <button onclick="closeTrainingModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <form onsubmit="event.preventDefault(); updateTraining('${trainingId}');" class="p-6 space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Titre de la Formation</label>
                                <input id="training-title" type="text" required value="${training.title}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Description</label>
                                <textarea id="training-description" required rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">${training.description}</textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Formateur</label>
                                    <input id="training-instructor" type="text" required value="${training.instructor}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Niveau</label>
                                    <select id="training-level" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="Débutant" ${training.level === 'Débutant' ? 'selected' : ''}>Débutant</option>
                                        <option value="Intermédiaire" ${training.level === 'Intermédiaire' ? 'selected' : ''}>Intermédiaire</option>
                                        <option value="Avancé" ${training.level === 'Avancé' ? 'selected' : ''}>Avancé</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Date</label>
                                    <input id="training-date" type="date" required value="${training.date}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Heure</label>
                                    <input id="training-time" type="time" required value="${training.time}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Durée</label>
                                    <input id="training-duration" type="text" required value="${training.duration}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Prix (DA)</label>
                                    <input id="training-price" type="number" required value="${training.price}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Nombre de Places</label>
                                    <input id="training-seats" type="number" required value="${training.seats}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Localisation</label>
                                <input id="training-location" type="text" required value="${training.location}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Icône</label>
                                    <select id="training-icon" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="code-2" ${training.icon === 'code-2' ? 'selected' : ''}>Code (Programmation)</option>
                                        <option value="wrench" ${training.icon === 'wrench' ? 'selected' : ''}>Wrench (Maintenance)</option>
                                        <option value="settings" ${training.icon === 'settings' ? 'selected' : ''}>Settings (Technique)</option>
                                        <option value="cpu" ${training.icon === 'cpu' ? 'selected' : ''}>CPU (Technologie)</option>
                                        <option value="tool" ${training.icon === 'tool' ? 'selected' : ''}>Tool (Outillage)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Couleur</label>
                                    <select id="training-color" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="bg-blue-500" ${training.color === 'bg-blue-500' ? 'selected' : ''}>Bleu</option>
                                        <option value="bg-green-500" ${training.color === 'bg-green-500' ? 'selected' : ''}>Vert</option>
                                        <option value="bg-purple-500" ${training.color === 'bg-purple-500' ? 'selected' : ''}>Violet</option>
                                        <option value="bg-red-500" ${training.color === 'bg-red-500' ? 'selected' : ''}>Rouge</option>
                                        <option value="bg-orange-500" ${training.color === 'bg-orange-500' ? 'selected' : ''}>Orange</option>
                                        <option value="bg-cyan-500" ${training.color === 'bg-cyan-500' ? 'selected' : ''}>Cyan</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="closeTrainingModal()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-lg hover:bg-slate-200 transition-colors">
                                    Annuler
                                </button>
                                <button type="submit" class="flex-1 bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-600 transition-all">
                                    Enregistrer les modifications
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function closeTrainingModal() {
            const modal = document.getElementById('training-modal');
            if (modal) modal.remove();
        }

        function createTraining() {
            const newTraining = {
                id: `TRAIN-${String(Date.now()).slice(-3)}`,
                title: document.getElementById('training-title').value,
                description: document.getElementById('training-description').value,
                instructor: document.getElementById('training-instructor').value,
                level: document.getElementById('training-level').value,
                date: document.getElementById('training-date').value,
                time: document.getElementById('training-time').value,
                duration: document.getElementById('training-duration').value,
                price: parseInt(document.getElementById('training-price').value),
                seats: parseInt(document.getElementById('training-seats').value),
                booked: 0,
                location: document.getElementById('training-location').value,
                icon: document.getElementById('training-icon').value,
                color: document.getElementById('training-color').value
            };

            scheduledTrainings.push(newTraining);
            alert('✅ Formation créée avec succès !');
            closeTrainingModal();
            render();
        }

        function updateTraining(trainingId) {
            const training = scheduledTrainings.find(t => t.id === trainingId);
            if (!training) return;

            training.title = document.getElementById('training-title').value;
            training.description = document.getElementById('training-description').value;
            training.instructor = document.getElementById('training-instructor').value;
            training.level = document.getElementById('training-level').value;
            training.date = document.getElementById('training-date').value;
            training.time = document.getElementById('training-time').value;
            training.duration = document.getElementById('training-duration').value;
            training.price = parseInt(document.getElementById('training-price').value);
            training.seats = parseInt(document.getElementById('training-seats').value);
            training.location = document.getElementById('training-location').value;
            training.icon = document.getElementById('training-icon').value;
            training.color = document.getElementById('training-color').value;

            alert('✅ Formation mise à jour avec succès !');
            closeTrainingModal();
            render();
        }

        function deleteTraining(trainingId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette formation ?')) return;

            const index = scheduledTrainings.findIndex(t => t.id === trainingId);
            if (index !== -1) {
                scheduledTrainings.splice(index, 1);
                alert('✅ Formation supprimée avec succès !');
                render();
            }
        }

        function renderAdminMessages() {
            return `
                <div class="space-y-4">
                    <h2 class="text-lg font-black text-slate-900 px-1">Messages Support Client (${AppState.supportMessages.length})</h2>
                    
                    ${AppState.supportMessages.map(msg => `
                        <div class="bg-white rounded-xl border ${msg.status === 'unread' ? 'border-red-300 shadow-md' : 'border-slate-100'} overflow-hidden">
                            <!-- Message Header -->
                            <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                        ${msg.clientName.split(' ').map(n => n[0]).join('')}
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-900">${msg.clientName}</div>
                                        <div class="text-xs text-slate-500">${msg.clientEmail}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${msg.status === 'unread' ? `
                                        <span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded-full">Non lu</span>
                                    ` : `
                                        <span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded-full">Répondu</span>
                                    `}
                                </div>
                            </div>

                            <!-- Message Body -->
                            <div class="p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
                                    <span class="text-xs text-slate-500">${msg.date}</span>
                                    ${msg.orderId ? `
                                        <span class="text-xs text-slate-400">•</span>
                                        <span class="text-xs font-bold text-blue-600">${msg.orderId}</span>
                                    ` : ''}
                                </div>
                                <div class="font-bold text-slate-900 mb-1">${msg.subject}</div>
                                <div class="text-sm text-slate-600 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                    ${msg.message}
                                </div>

                                <!-- Replies -->
                                ${msg.replies.length > 0 ? `
                                    <div class="space-y-2 mb-4 pl-4 border-l-2 border-blue-200">
                                        ${msg.replies.map(reply => `
                                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span class="text-xs font-bold text-blue-700">Vous (Admin)</span>
                                                    <span class="text-xs text-slate-500">${reply.timestamp}</span>
                                                </div>
                                                <div class="text-sm text-slate-700">${reply.text}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}

                                <!-- Reply Form -->
                                <div class="flex gap-2">
                                    <input
                                        id="reply-${msg.id}"
                                        type="text"
                                        placeholder="Écrivez votre réponse..."
                                        class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                    />
                                    <button 
                                        onclick="replyToMessage('${msg.id}', document.getElementById('reply-${msg.id}').value); document.getElementById('reply-${msg.id}').value = '';"
                                        class="bg-red-500 text-white font-bold px-4 py-2 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2"
                                    >
                                        <i data-lucide="send" class="w-4 h-4"></i> Envoyer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAdminOrders() {
            return `
                <div class="space-y-4">
                    <h2 class="text-lg font-black text-slate-900 px-1">Gestion des Commandes (${AppState.orders.length})</h2>
                    
                    ${AppState.orders.map(order => `
                        <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                            <!-- Order Header -->
                            <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center justify-between">
                                <div>
                                    <div class="font-black text-slate-900 text-lg">${order.id}</div>
                                    <div class="text-sm text-slate-600">${order.client} • ${order.clientEmail}</div>
                                </div>
                                <span class="text-xs font-bold px-3 py-1.5 rounded-full ${order.status === 'WAITING' ? 'bg-blue-100 text-blue-700' :
                    order.status === 'MACHINING' ? 'bg-amber-100 text-amber-700' :
                        'bg-green-100 text-green-700'
                }">
                                    ${order.status}
                                </span>
                            </div>

                            <!-- Order Details -->
                            <div class="p-4 space-y-3">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="file-text" class="w-4 h-4 text-slate-400"></i>
                                    <span class="text-sm font-medium text-slate-700">${order.file}</span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 p-3 bg-slate-50 rounded-lg">
                                    <div>
                                        <div class="text-xs text-slate-500">Matière</div>
                                        <div class="text-sm font-bold text-slate-900">${order.config.material}</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-slate-500">Procédé</div>
                                        <div class="text-sm font-bold text-slate-900">${order.config.process}</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-slate-500">Quantité</div>
                                        <div class="text-sm font-bold text-slate-900">${order.config.quantity} pcs</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-slate-500">Montant</div>
                                        <div class="text-sm font-bold text-red-600">${order.price.toLocaleString('fr-FR')} DA</div>
                                    </div>
                                </div>

                                <!-- Workshop Assignment -->
                                <div class="border-t border-slate-100 pt-3 mt-3">
                                    <div class="text-xs font-bold text-slate-700 mb-2 flex items-center gap-2">
                                        <i data-lucide="factory" class="w-4 h-4"></i> Atelier assigné
                                    </div>
                                    ${order.assignedWorkshop ? `
                                        <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                                            <span class="text-sm font-bold text-green-700">${order.assignedWorkshop}</span>
                                            <button onclick="assignOrderToWorkshop('${order.id}', null)" class="text-xs text-red-600 hover:underline">Réassigner</button>
                                        </div>
                                    ` : `
                                        <select 
                                            onchange="if(this.value) assignOrderToWorkshop('${order.id}', this.value);"
                                            class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-red-500"
                                        >
                                            <option value="">Sélectionner un atelier...</option>
                                            ${AppState.workshops
                    .filter(w => w.specialties.some(s => order.config.process.includes(s.split(' ')[0])))
                    .map(workshop => `
                                                    <option value="${workshop.name}">
                                                        ${workshop.name} - ${workshop.city} (Cap: ${workshop.capacity}%)
                                                    </option>
                                                `).join('')}
                                        </select>
                                    `}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAdminWorkshops() {
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h2 class="text-lg font-black text-slate-900">Réseau d'Ateliers Partenaires (${AppState.workshops.length})</h2>
                        <button onclick="openCreateWorkshopModal()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all inline-flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Ajouter Atelier</span>
                        </button>
                    </div>
                    
                    ${AppState.workshops.length === 0 ? `
                        <div class="bg-white rounded-xl border border-slate-200 p-12 text-center">
                            <i data-lucide="factory" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
                            <h3 class="text-lg font-bold text-slate-700 mb-2">Aucun atelier partenaire</h3>
                            <p class="text-sm text-slate-500 mb-4">Ajoutez votre premier atelier partenaire</p>
                            <button onclick="openCreateWorkshopModal()" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors">
                                Ajouter un atelier
                            </button>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${AppState.workshops.map(workshop => `
                                <div class="bg-white rounded-xl border border-slate-100 shadow-sm p-5">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex-1">
                                            <div class="font-black text-lg text-slate-900">${workshop.name}</div>
                                            <div class="text-sm text-slate-600 flex items-center gap-2 mt-1">
                                                <i data-lucide="map-pin" class="w-4 h-4"></i> ${workshop.city}
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="flex items-center gap-1">
                                                <i data-lucide="star" class="w-4 h-4 text-amber-500 fill-amber-500"></i>
                                                <span class="text-sm font-bold text-slate-900">${workshop.rating}</span>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="openEditWorkshopModal('${workshop.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Modifier">
                                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="deleteWorkshop('${workshop.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Supprimer">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex flex-wrap gap-2 mb-3">
                                        ${workshop.specialties.map(spec => `
                                            <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                                ${spec}
                                            </span>
                                        `).join('')}
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="bg-slate-50 p-3 rounded-lg">
                                            <div class="text-xs text-slate-500 mb-1">Capacité</div>
                                            <div class="flex items-center gap-2">
                                                <div class="flex-1 bg-slate-200 h-2 rounded-full overflow-hidden">
                                                    <div class="bg-gradient-to-r from-green-500 to-green-600 h-full transition-all" style="width: ${workshop.capacity}%"></div>
                                                </div>
                                                <span class="text-sm font-bold text-slate-900">${workshop.capacity}%</span>
                                            </div>
                                        </div>
                                        <div class="bg-slate-50 p-3 rounded-lg">
                                            <div class="text-xs text-slate-500 mb-1">Commandes actives</div>
                                            <div class="text-2xl font-black text-[#005f9e]">${workshop.activeOrders}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        // ==================== WORKSHOP MANAGEMENT FUNCTIONS ====================
        function openCreateWorkshopModal() {
            const modalHTML = `
                <div id="workshop-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeWorkshopModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-scale-in">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-black text-slate-900">Ajouter un Atelier Partenaire</h2>
                            <button onclick="closeWorkshopModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <form onsubmit="event.preventDefault(); createWorkshop();" class="p-6 space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Nom de l'Atelier</label>
                                <input id="workshop-name" type="text" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium" placeholder="Ex: Atelier Precision CNC Alger">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Ville / Wilaya</label>
                                <select id="workshop-city" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Sélectionner une ville...</option>
                                    <option value="Alger">Alger</option>
                                    <option value="Oran">Oran</option>
                                    <option value="Constantine">Constantine</option>
                                    <option value="Annaba">Annaba</option>
                                    <option value="Blida">Blida</option>
                                    <option value="Sétif">Sétif</option>
                                    <option value="Tlemcen">Tlemcen</option>
                                    <option value="Batna">Batna</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Spécialités (sélectionner plusieurs)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Fraisage CNC" class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Fraisage CNC</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Tournage CNC" class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Tournage CNC</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Impression 3D" class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Impression 3D</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Tôlerie" class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Tôlerie</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Moulage Injection" class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Moulage Injection</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Usinage 5 axes" class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Usinage 5 axes</span>
                                    </label>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Capacité (%)</label>
                                    <input id="workshop-capacity" type="number" required min="0" max="100" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: 75">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Note (0-5)</label>
                                    <input id="workshop-rating" type="number" required min="0" max="5" step="0.1" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: 4.5">
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="closeWorkshopModal()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-lg hover:bg-slate-200 transition-colors">
                                    Annuler
                                </button>
                                <button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all">
                                    Ajouter l'Atelier
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function openEditWorkshopModal(workshopId) {
            const workshop = AppState.workshops.find(w => w.id === workshopId);
            if (!workshop) return;

            const modalHTML = `
                <div id="workshop-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeWorkshopModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-scale-in">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-black text-slate-900">Modifier l'Atelier</h2>
                            <button onclick="closeWorkshopModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <form onsubmit="event.preventDefault(); updateWorkshop('${workshopId}');" class="p-6 space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Nom de l'Atelier</label>
                                <input id="workshop-name" type="text" required value="${workshop.name}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Ville / Wilaya</label>
                                <select id="workshop-city" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Sélectionner une ville...</option>
                                    <option value="Alger" ${workshop.city === 'Alger' ? 'selected' : ''}>Alger</option>
                                    <option value="Oran" ${workshop.city === 'Oran' ? 'selected' : ''}>Oran</option>
                                    <option value="Constantine" ${workshop.city === 'Constantine' ? 'selected' : ''}>Constantine</option>
                                    <option value="Annaba" ${workshop.city === 'Annaba' ? 'selected' : ''}>Annaba</option>
                                    <option value="Blida" ${workshop.city === 'Blida' ? 'selected' : ''}>Blida</option>
                                    <option value="Sétif" ${workshop.city === 'Sétif' ? 'selected' : ''}>Sétif</option>
                                    <option value="Tlemcen" ${workshop.city === 'Tlemcen' ? 'selected' : ''}>Tlemcen</option>
                                    <option value="Batna" ${workshop.city === 'Batna' ? 'selected' : ''}>Batna</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Spécialités (sélectionner plusieurs)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Fraisage CNC" ${workshop.specialties.includes('Fraisage CNC') ? 'checked' : ''} class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Fraisage CNC</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Tournage CNC" ${workshop.specialties.includes('Tournage CNC') ? 'checked' : ''} class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Tournage CNC</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Impression 3D" ${workshop.specialties.includes('Impression 3D') ? 'checked' : ''} class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Impression 3D</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Tôlerie" ${workshop.specialties.includes('Tôlerie') ? 'checked' : ''} class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Tôlerie</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Moulage Injection" ${workshop.specialties.includes('Moulage Injection') ? 'checked' : ''} class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Moulage Injection</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" name="specialty" value="Usinage 5 axes" ${workshop.specialties.includes('Usinage 5 axes') ? 'checked' : ''} class="w-4 h-4 text-blue-600">
                                        <span class="text-sm font-medium">Usinage 5 axes</span>
                                    </label>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Capacité (%)</label>
                                    <input id="workshop-capacity" type="number" required min="0" max="100" value="${workshop.capacity}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Note (0-5)</label>
                                    <input id="workshop-rating" type="number" required min="0" max="5" step="0.1" value="${workshop.rating}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="closeWorkshopModal()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-lg hover:bg-slate-200 transition-colors">
                                    Annuler
                                </button>
                                <button type="submit" class="flex-1 bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-600 transition-all">
                                    Enregistrer les modifications
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function closeWorkshopModal() {
            const modal = document.getElementById('workshop-modal');
            if (modal) modal.remove();
        }

        function createWorkshop() {
            const name = document.getElementById('workshop-name').value;
            const city = document.getElementById('workshop-city').value;
            const capacity = parseInt(document.getElementById('workshop-capacity').value);
            const rating = parseFloat(document.getElementById('workshop-rating').value);

            const specialties = Array.from(document.querySelectorAll('input[name="specialty"]:checked'))
                .map(checkbox => checkbox.value);

            if (specialties.length === 0) {
                alert('⚠️ Veuillez sélectionner au moins une spécialité');
                return;
            }

            const newWorkshop = {
                id: `WS-${String(Date.now()).slice(-3)}`,
                name: name,
                city: city,
                specialties: specialties,
                capacity: capacity,
                rating: rating,
                activeOrders: 0
            };

            AppState.workshops.push(newWorkshop);
            alert('✅ Atelier ajouté avec succès !');
            closeWorkshopModal();
            render();
        }

        function updateWorkshop(workshopId) {
            const workshop = AppState.workshops.find(w => w.id === workshopId);
            if (!workshop) return;

            workshop.name = document.getElementById('workshop-name').value;
            workshop.city = document.getElementById('workshop-city').value;
            workshop.capacity = parseInt(document.getElementById('workshop-capacity').value);
            workshop.rating = parseFloat(document.getElementById('workshop-rating').value);

            workshop.specialties = Array.from(document.querySelectorAll('input[name="specialty"]:checked'))
                .map(checkbox => checkbox.value);

            if (workshop.specialties.length === 0) {
                alert('⚠️ Veuillez sélectionner au moins une spécialité');
                return;
            }

            alert('✅ Atelier mis à jour avec succès !');
            closeWorkshopModal();
            render();
        }

        function deleteWorkshop(workshopId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cet atelier partenaire ?')) return;

            const index = AppState.workshops.findIndex(w => w.id === workshopId);
            if (index !== -1) {
                AppState.workshops.splice(index, 1);
                alert('✅ Atelier supprimé avec succès !');
                render();
            }
        }

        function renderAdminAnalytics() {
            const totalRevenue = AppState.orders.reduce((sum, order) => sum + order.price, 0);
            const avgOrderValue = totalRevenue / AppState.orders.length;

            return `
                <div class="space-y-4">
                    <h2 class="text-lg font-black text-slate-900 px-1">Tableau de Bord Analytics</h2>
                    
                    <!-- Revenue Cards -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-xl shadow-lg">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="trending-up" class="w-5 h-5"></i>
                                <div class="text-xs font-bold opacity-90">Revenu Total</div>
                            </div>
                            <div class="text-2xl font-black">${totalRevenue.toLocaleString('fr-FR')} DA</div>
                        </div>

                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-xl shadow-lg">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                                <div class="text-xs font-bold opacity-90">Panier Moyen</div>
                            </div>
                            <div class="text-2xl font-black">${Math.round(avgOrderValue).toLocaleString('fr-FR')} DA</div>
                        </div>
                    </div>

                    <!-- Orders by Status -->
                    <div class="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
                        <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-5 h-5 text-blue-600"></i>
                            Répartition des Commandes
                        </h3>
                        <div class="space-y-3">
                            ${['WAITING', 'MACHINING', 'QC'].map(status => {
                const count = AppState.orders.filter(o => o.status === status).length;
                const percentage = (count / AppState.orders.length * 100).toFixed(0);
                return `
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="font-medium text-slate-700">${status}</span>
                                            <span class="font-bold text-slate-900">${count} (${percentage}%)</span>
                                        </div>
                                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full ${status === 'WAITING' ? 'bg-blue-500' :
                        status === 'MACHINING' ? 'bg-amber-500' :
                            'bg-green-500'
                    } transition-all" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                    </div>

                    <!-- Top Processes -->
                    <div class="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
                        <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
                            <i data-lucide="bar-chart-2" class="w-5 h-5 text-purple-600"></i>
                            Procédés les plus demandés
                        </h3>
                        <div class="space-y-2">
                            ${Object.entries(
                AppState.orders.reduce((acc, order) => {
                    acc[order.config.process] = (acc[order.config.process] || 0) + 1;
                    return acc;
                }, {})
            ).sort((a, b) => b[1] - a[1]).map(([process, count]) => `
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                    <span class="text-sm font-medium text-slate-700">${process}</span>
                                    <span class="text-lg font-black text-purple-600">${count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminClients() {
            const totalRevenue = AppState.clients.reduce((sum, client) => sum + (client.totalRevenue || 0), 0);
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h2 class="text-lg font-black text-slate-900">Clients (${AppState.clients.length})</h2>
                        <button onclick="openClientModal()" class="bg-gradient-to-r from-sky-500 to-sky-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all inline-flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Ajouter un client</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm flex items-center justify-between">
                        <div>
                            <div class="text-xs text-slate-500 font-bold">Chiffre d'affaires cumulé</div>
                            <div class="text-2xl font-black text-[#005f9e]">${totalRevenue.toLocaleString('fr-FR')} DA</div>
                        </div>
                        <div class="text-xs text-slate-400">Top clients: ${AppState.clients.slice(0, 3).map(c => c.company).join(', ')}</div>
                    </div>

                    ${AppState.clients.length === 0 ? `
                        <div class="bg-white rounded-xl border border-slate-200 p-10 text-center">
                            <i data-lucide="users" class="w-12 h-12 text-slate-300 mx-auto mb-3"></i>
                            <p class="text-sm text-slate-500">Aucun client enregistré.</p>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${AppState.clients.map(client => `
                                <div class="bg-white rounded-xl border border-slate-100 shadow-sm p-5">
                                    <div class="flex items-start justify-between gap-4">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <h3 class="font-black text-slate-900 text-lg">${client.company}</h3>
                                                <span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full">${client.sector}</span>
                                            </div>
                                            <div class="text-sm text-slate-500 mt-1 flex flex-wrap gap-3">
                                                <span class="flex items-center gap-1"><i data-lucide="user" class="w-4 h-4"></i>${client.contact}</span>
                                                <span class="flex items-center gap-1"><i data-lucide="mail" class="w-4 h-4"></i>${client.email}</span>
                                                <span class="flex items-center gap-1"><i data-lucide="phone" class="w-4 h-4"></i>${client.phone}</span>
                                            </div>
                                            <p class="text-xs text-slate-500 mt-3">${client.notes || '—'}</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-slate-400">CA total</div>
                                            <div class="text-lg font-black text-green-600">${client.totalRevenue.toLocaleString('fr-FR')} DA</div>
                                            <div class="text-xs text-slate-500">${client.totalOrders} commandes</div>
                                            <div class="flex gap-2 mt-3">
                                                <button onclick="openClientModal('${client.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Modifier">
                                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="deleteClient('${client.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Supprimer">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function openClientModal(clientId = null) {
            const client = clientId ? AppState.clients.find(c => c.id === clientId) : null;
            const modalHTML = `
                <div id="client-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeClientModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-scale-in">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-black text-slate-900">${client ? 'Modifier le client' : 'Ajouter un client'}</h2>
                            <button onclick="closeClientModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <form onsubmit="event.preventDefault(); ${client ? `updateClient('${client.id}')` : 'createClient()'};" class="p-6 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Entreprise</label>
                                    <input id="client-company" type="text" value="${client?.company || ''}" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500" placeholder="Nom de l'entreprise">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Secteur</label>
                                    <input id="client-sector" type="text" value="${client?.sector || ''}" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500" placeholder="Ex: Plasturgie">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Contact</label>
                                    <input id="client-contact" type="text" value="${client?.contact || ''}" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500" placeholder="Nom du contact">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Téléphone</label>
                                    <input id="client-phone" type="tel" value="${client?.phone || ''}" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500" placeholder="+213 ...">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Email</label>
                                    <input id="client-email" type="email" value="${client?.email || ''}" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500" placeholder="email@client.dz">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Commandes totales</label>
                                    <input id="client-orders" type="number" min="0" value="${client?.totalOrders || 0}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Chiffre d'affaires (DA)</label>
                                    <input id="client-revenue" type="number" min="0" value="${client?.totalRevenue || 0}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Notes internes</label>
                                    <textarea id="client-notes" rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500" placeholder="Paiement, exigences...">${client?.notes || ''}</textarea>
                                </div>
                            </div>
                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="closeClientModal()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-lg hover:bg-slate-200 transition-colors">Annuler</button>
                                <button type="submit" class="flex-1 bg-gradient-to-r from-sky-500 to-sky-600 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all">${client ? 'Enregistrer' : 'Ajouter le client'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function closeClientModal() {
            const modal = document.getElementById('client-modal');
            if (modal) modal.remove();
        }

        function createClient() {
            const newClient = {
                id: `CL-${String(Date.now()).slice(-3)}`,
                company: document.getElementById('client-company').value,
                contact: document.getElementById('client-contact').value,
                email: document.getElementById('client-email').value,
                phone: document.getElementById('client-phone').value,
                sector: document.getElementById('client-sector').value,
                notes: document.getElementById('client-notes').value,
                totalOrders: parseInt(document.getElementById('client-orders').value || '0'),
                totalRevenue: parseInt(document.getElementById('client-revenue').value || '0')
            };
            AppState.clients.unshift(newClient);
            alert('✅ Client ajouté avec succès !');
            closeClientModal();
            render();
        }

        function updateClient(clientId) {
            const client = AppState.clients.find(c => c.id === clientId);
            if (!client) return;
            client.company = document.getElementById('client-company').value;
            client.contact = document.getElementById('client-contact').value;
            client.email = document.getElementById('client-email').value;
            client.phone = document.getElementById('client-phone').value;
            client.sector = document.getElementById('client-sector').value;
            client.notes = document.getElementById('client-notes').value;
            client.totalOrders = parseInt(document.getElementById('client-orders').value || '0');
            client.totalRevenue = parseInt(document.getElementById('client-revenue').value || '0');
            alert('✅ Client mis à jour !');
            closeClientModal();
            render();
        }

        function deleteClient(clientId) {
            if (!confirm('Supprimer ce client ?')) return;
            const index = AppState.clients.findIndex(c => c.id === clientId);
            if (index !== -1) {
                AppState.clients.splice(index, 1);
                render();
            }
        }

        function renderAdminTeam() {
            const activeCount = AppState.team.filter(emp => emp.active).length;
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h2 class="text-lg font-black text-slate-900">Équipe (${AppState.team.length})</h2>
                        <button onclick="openTeamModal()" class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all inline-flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Ajouter un membre</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm flex items-center justify-between">
                        <div>
                            <div class="text-xs text-slate-500 font-bold">Membres actifs</div>
                            <div class="text-2xl font-black text-indigo-600">${activeCount}/${AppState.team.length}</div>
                        </div>
                        <div class="text-xs text-slate-400">Compétences clés: ${[...new Set(AppState.team.flatMap(emp => emp.skills))].slice(0, 4).join(', ')}</div>
                    </div>

                    ${AppState.team.length === 0 ? `
                        <div class="bg-white rounded-xl border border-slate-200 p-10 text-center">
                            <i data-lucide="users" class="w-12 h-12 text-slate-300 mx-auto mb-3"></i>
                            <p class="text-sm text-slate-500">Aucun employé pour le moment.</p>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${AppState.team.map(emp => `
                                <div class="bg-white rounded-xl border border-slate-100 shadow-sm p-5">
                                    <div class="flex items-start justify-between gap-4">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <h3 class="font-bold text-slate-900 text-lg">${emp.name}</h3>
                                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${emp.active ? 'bg-green-100 text-green-600' : 'bg-slate-200 text-slate-600'}">${emp.active ? 'Actif' : 'Inactive'}</span>
                                            </div>
                                            <div class="text-sm text-slate-500 mb-2">${emp.role}</div>
                                            <div class="flex flex-wrap gap-2">
                                                ${emp.skills.map(skill => `<span class="text-[10px] font-semibold bg-slate-100 text-slate-600 px-2 py-0.5 rounded">${skill}</span>`).join('')}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-slate-400">TJM horaire</div>
                                            <div class="text-lg font-black text-indigo-600">${emp.hourlyRate} DA/h</div>
                                            <div class="flex gap-2 mt-3">
                                                <button onclick="openTeamModal('${emp.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Modifier">
                                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="deleteTeamMember('${emp.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Supprimer">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        // ==================== ADMIN STOCK ====================
        function renderAdminStock() {
            const lowStockItems = AppState.inventory.filter(item => item.stock <= item.minStock);
            const materials = AppState.inventory.filter(item => item.type === 'Matière');
            const tools = AppState.inventory.filter(item => item.type === 'Outil');
            const consumables = AppState.inventory.filter(item => item.type === 'Consommable');

            return `
                <div class="space-y-5">
                    <div class="flex items-center justify-between px-1">
                        <h2 class="text-lg font-black text-slate-900">Gestion des Stocks (${AppState.inventory.length})</h2>
                        <button onclick="openStockModal()" class="bg-gradient-to-r from-amber-500 to-amber-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all inline-flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Ajouter un article</span>
                        </button>
                    </div>

                    ${lowStockItems.length > 0 ? `
                        <div class="bg-white rounded-xl border border-amber-200 p-4 shadow-sm">
                            <div class="flex items-center gap-2 text-amber-600 font-bold text-sm mb-3">
                                <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                                <span>Articles à commander (${lowStockItems.length})</span>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${lowStockItems.map(item => `
                                    <span class="px-3 py-1 bg-amber-50 border border-amber-200 rounded-full text-xs font-semibold text-amber-700">
                                        ${item.name} (${item.stock}${item.unit})
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <div class="text-xs text-slate-400 font-bold uppercase">Matières Premières</div>
                                    <div class="text-xl font-black text-slate-900">${materials.length}</div>
                                </div>
                                <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                                    <i data-lucide="layers" class="w-5 h-5"></i>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${materials.map(item => renderInventoryCard(item)).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <div class="text-xs text-slate-400 font-bold uppercase">Outils</div>
                                    <div class="text-xl font-black text-slate-900">${tools.length}</div>
                                </div>
                                <div class="p-2 bg-purple-50 text-purple-600 rounded-lg">
                                    <i data-lucide="tool" class="w-5 h-5"></i>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${tools.map(item => renderInventoryCard(item)).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <div class="text-xs text-slate-400 font-bold uppercase">Consommables</div>
                                    <div class="text-xl font-black text-slate-900">${consumables.length}</div>
                                </div>
                                <div class="p-2 bg-green-50 text-green-600 rounded-lg">
                                    <i data-lucide="droplet" class="w-5 h-5"></i>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${consumables.map(item => renderInventoryCard(item)).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInventoryCard(item) {
            const statusClass = item.stock <= item.minStock ? 'text-red-600 bg-red-50 border-red-100' : 'text-green-600 bg-green-50 border-green-100';
            const statusText = item.stock <= item.minStock ? 'À commander' : 'OK';

            return `
                <div class="border border-slate-100 rounded-lg p-3 text-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-bold text-slate-900">${item.name}</div>
                            <div class="text-xs text-slate-500">${item.reference} • ${item.category}</div>
                        </div>
                        <div class="text-xs font-bold px-2 py-1 rounded-full border ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-2 text-xs text-slate-600">
                        <span>Stock: <strong>${item.stock}${item.unit}</strong></span>
                        <span>Min: ${item.minStock}${item.unit}</span>
                    </div>
                    <div class="flex items-center justify-between mt-2 text-xs text-slate-500">
                        <span>Fournisseur</span>
                        <span class="font-semibold text-slate-700">${item.supplier}</span>
                    </div>
                    <div class="flex items-center gap-2 mt-3">
                        <button onclick="openEditStockModal('${item.id}')" class="flex-1 text-xs font-bold text-blue-600 bg-blue-50 border border-blue-100 rounded-lg py-1.5">Modifier</button>
                        <button onclick="deleteInventoryItem('${item.id}')" class="flex-1 text-xs font-bold text-red-600 bg-red-50 border border-red-100 rounded-lg py-1.5">Supprimer</button>
                    </div>
                </div>
            `;
        }

        function openStockModal() {
            const modalHTML = `
                <div id="stock-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeStockModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-scale-in">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-black text-slate-900">Ajouter un Article</h2>
                            <button onclick="closeStockModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <form onsubmit="event.preventDefault(); createInventoryItem();" class="p-6 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Type</label>
                                    <select id="inventory-type" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                        <option value="Matière">Matière</option>
                                        <option value="Outil">Outil</option>
                                        <option value="Consommable">Consommable</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Catégorie</label>
                                    <input id="inventory-category" type="text" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Ex: Matières Premières">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Nom</label>
                                    <input id="inventory-name" type="text" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Ex: Aluminium 6061">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Référence</label>
                                    <input id="inventory-reference" type="text" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Ex: AL-6061-PL8">
                                </div>
                            </div>

                            <div class="grid grid-cols-4 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Stock</label>
                                    <input id="inventory-stock" type="number" required class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="120">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Min</label>
                                    <input id="inventory-min" type="number" required class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="40">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Unité</label>
                                    <input id="inventory-unit" type="text" required class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="kg / pcs">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Fournisseur</label>
                                    <input id="inventory-supplier" type="text" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Ex: MetalAlgérie">
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="closeStockModal()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-lg hover:bg-slate-200 transition-colors">
                                    Annuler
                                </button>
                                <button type="submit" class="flex-1 bg-gradient-to-r from-amber-500 to-amber-600 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all">
                                    Ajouter au stock
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function openEditStockModal(itemId) {
            const item = AppState.inventory.find(inv => inv.id === itemId);
            if (!item) return;

            const modalHTML = `
                <div id="stock-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeStockModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-scale-in">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-black text-slate-900">Modifier l'article</h2>
                            <button onclick="closeStockModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <form onsubmit="event.preventDefault(); updateInventoryItem('${item.id}');" class="p-6 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Type</label>
                                    <select id="inventory-type" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                        <option value="Matière" ${item.type === 'Matière' ? 'selected' : ''}>Matière</option>
                                        <option value="Outil" ${item.type === 'Outil' ? 'selected' : ''}>Outil</option>
                                        <option value="Consommable" ${item.type === 'Consommable' ? 'selected' : ''}>Consommable</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Catégorie</label>
                                    <input id="inventory-category" type="text" required value="${item.category}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Nom</label>
                                    <input id="inventory-name" type="text" required value="${item.name}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Référence</label>
                                    <input id="inventory-reference" type="text" required value="${item.reference}" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                </div>
                            </div>

                            <div class="grid grid-cols-4 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Stock</label>
                                    <input id="inventory-stock" type="number" required value="${item.stock}" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Min</label>
                                    <input id="inventory-min" type="number" required value="${item.minStock}" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Unité</label>
                                    <input id="inventory-unit" type="text" required value="${item.unit}" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-2">Fournisseur</label>
                                    <input id="inventory-supplier" type="text" value="${item.supplier}" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="closeStockModal()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-lg hover:bg-slate-200 transition-colors">
                                    Annuler
                                </button>
                                <button type="submit" class="flex-1 bg-gradient-to-r from-amber-500 to-amber-600 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all">
                                    Enregistrer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function closeStockModal() {
            const modal = document.getElementById('stock-modal');
            if (modal) modal.remove();
        }

        function createInventoryItem() {
            const newItem = {
                id: `INV-${String(Date.now()).slice(-3)}`,
                type: document.getElementById('inventory-type').value,
                category: document.getElementById('inventory-category').value,
                name: document.getElementById('inventory-name').value,
                reference: document.getElementById('inventory-reference').value,
                stock: parseFloat(document.getElementById('inventory-stock').value),
                minStock: parseFloat(document.getElementById('inventory-min').value),
                unit: document.getElementById('inventory-unit').value,
                supplier: document.getElementById('inventory-supplier').value
            };

            AppState.inventory.push(newItem);
            alert('✅ Article ajouté au stock !');
            closeStockModal();
            render();
        }

        function updateInventoryItem(itemId) {
            const item = AppState.inventory.find(inv => inv.id === itemId);
            if (!item) return;

            item.type = document.getElementById('inventory-type').value;
            item.category = document.getElementById('inventory-category').value;
            item.name = document.getElementById('inventory-name').value;
            item.reference = document.getElementById('inventory-reference').value;
            item.stock = parseFloat(document.getElementById('inventory-stock').value);
            item.minStock = parseFloat(document.getElementById('inventory-min').value);
            item.unit = document.getElementById('inventory-unit').value;
            item.supplier = document.getElementById('inventory-supplier').value;

            alert('✅ Article mis à jour !');
            closeStockModal();
            render();
        }

        function deleteInventoryItem(itemId) {
            if (!confirm('Supprimer cet article ?')) return;
            const index = AppState.inventory.findIndex(inv => inv.id === itemId);
            if (index !== -1) {
                AppState.inventory.splice(index, 1);
                render();
            }
        }

        // ==================== ADMIN MACHINES ====================
        function renderAdminMachines() {
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h2 class="text-lg font-black text-slate-900">Parc Machines (${AppState.machines.length})</h2>
                        <button onclick="openMachineModal()" class="bg-gradient-to-r from-slate-700 to-slate-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all inline-flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Ajouter Machine</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-3">
                        ${AppState.machines.map(machine => `
                            <div class="bg-white rounded-xl border border-slate-100 shadow-sm p-4 flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="p-3 rounded-xl ${machine.status === 'Disponible' ? 'bg-green-100 text-green-600' : machine.status === 'Chargée' ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'}">
                                        <i data-lucide="cpu" class="w-6 h-6"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-slate-900">${machine.name}</h3>
                                        <div class="text-xs text-slate-500">${machine.type}</div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-6">
                                    <div class="text-right">
                                        <div class="text-xs text-slate-400 mb-1">Charge</div>
                                        <div class="font-bold ${machine.load > 80 ? 'text-red-600' : 'text-slate-700'}">${machine.load}%</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-slate-400 mb-1">Statut</div>
                                        <span class="text-xs font-bold px-2 py-1 rounded-full ${machine.status === 'Disponible' ? 'bg-green-100 text-green-700' : machine.status === 'Chargée' ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}">
                                            ${machine.status}
                                        </span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="openEditMachineModal('${machine.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Modifier">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="deleteMachine('${machine.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Supprimer">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function openMachineModal() {
            const modalHTML = `
                <div id="machine-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeMachineModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-scale-in">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-black text-slate-900">Ajouter Machine</h2>
                            <button onclick="closeMachineModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <form onsubmit="event.preventDefault(); createMachine();" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Nom Machine</label>
                                <input id="machine-name" type="text" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-500" placeholder="Ex: Haas VF2">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Type</label>
                                <select id="machine-type" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-500">
                                    <option>Fraisage 3 axes</option>
                                    <option>Fraisage 5 axes</option>
                                    <option>Tournage</option>
                                    <option>Impression 3D</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Statut</label>
                                <select id="machine-status" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-500">
                                    <option>Disponible</option>
                                    <option>Chargée</option>
                                    <option>Maintenance</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Charge Actuelle (%)</label>
                                <input id="machine-load" type="number" min="0" max="100" value="0" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-500">
                            </div>
                            <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition-all">Ajouter</button>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function openEditMachineModal(id) {
            const machine = AppState.machines.find(m => m.id === id);
            if (!machine) return;
            const modalHTML = `
                <div id="machine-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeMachineModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-scale-in">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-black text-slate-900">Modifier Machine</h2>
                            <button onclick="closeMachineModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <form onsubmit="event.preventDefault(); updateMachine('${id}');" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Nom Machine</label>
                                <input id="machine-name" type="text" value="${machine.name}" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Type</label>
                                <select id="machine-type" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-500">
                                    <option ${machine.type === 'Fraisage 3 axes' ? 'selected' : ''}>Fraisage 3 axes</option>
                                    <option ${machine.type === 'Fraisage 5 axes' ? 'selected' : ''}>Fraisage 5 axes</option>
                                    <option ${machine.type === 'Tournage' ? 'selected' : ''}>Tournage</option>
                                    <option ${machine.type === 'Impression 3D' ? 'selected' : ''}>Impression 3D</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Statut</label>
                                <select id="machine-status" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-500">
                                    <option ${machine.status === 'Disponible' ? 'selected' : ''}>Disponible</option>
                                    <option ${machine.status === 'Chargée' ? 'selected' : ''}>Chargée</option>
                                    <option ${machine.status === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Charge Actuelle (%)</label>
                                <input id="machine-load" type="number" min="0" max="100" value="${machine.load}" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-500">
                            </div>
                            <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition-all">Sauvegarder</button>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function closeMachineModal() {
            const el = document.getElementById('machine-modal');
            if (el) el.remove();
        }

        function createMachine() {
            const newMachine = {
                id: `MC-${String(Date.now()).slice(-3)}`,
                name: document.getElementById('machine-name').value,
                type: document.getElementById('machine-type').value,
                status: document.getElementById('machine-status').value,
                load: parseInt(document.getElementById('machine-load').value)
            };
            AppState.machines.push(newMachine);
            closeMachineModal();
            render();
        }

        function updateMachine(id) {
            const m = AppState.machines.find(x => x.id === id);
            if (m) {
                m.name = document.getElementById('machine-name').value;
                m.type = document.getElementById('machine-type').value;
                m.status = document.getElementById('machine-status').value;
                m.load = parseInt(document.getElementById('machine-load').value);
            }
            closeMachineModal();
            render();
        }

        function deleteMachine(id) {
            if (confirm('Supprimer cette machine ?')) {
                AppState.machines = AppState.machines.filter(x => x.id !== id);
                render();
            }
        }

        // ==================== ADMIN QUALITY ====================
        function renderAdminQuality() {
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h2 class="text-lg font-black text-slate-900">Contrôle Qualité (${AppState.nonConformities.length})</h2>
                        <button onclick="openQualityModal()" class="bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all inline-flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Signaler NC</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-3">
                        ${AppState.nonConformities.map(nc => `
                            <div class="bg-white rounded-xl border border-slate-100 shadow-sm p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="font-bold text-slate-900 flex items-center gap-2">
                                            <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-500"></i>
                                            ${nc.type}
                                        </div>
                                        <div class="text-xs text-slate-500">${nc.orderId} • ${nc.client}</div>
                                    </div>
                                    <span class="text-[10px] font-bold px-2 py-1 rounded-full ${nc.status === 'Ouvert' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                        ${nc.status}
                                    </span>
                                </div>
                                <p class="text-sm text-slate-700 bg-slate-50 p-2 rounded-lg mb-2">${nc.description}</p>
                                <div class="flex justify-between items-center">
                                    <div class="text-xs text-slate-500">Action: <strong>${nc.action}</strong></div>
                                    <div class="flex gap-2">
                                        <button onclick="openEditQualityModal('${nc.id}')" class="text-blue-600 hover:underline text-xs font-bold">Modifier</button>
                                        <button onclick="deleteQuality('${nc.id}')" class="text-red-600 hover:underline text-xs font-bold">Supprimer</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function openQualityModal() {
            const modalHTML = `
                <div id="quality-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeQualityModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-scale-in">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-black text-slate-900">Signaler Non-Conformité</h2>
                            <button onclick="closeQualityModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <form onsubmit="event.preventDefault(); createQuality();" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">ID Commande</label>
                                <input id="nc-order" type="text" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="DZ-2024-XXX">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Client</label>
                                <input id="nc-client" type="text" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Type de défaut</label>
                                <select id="nc-type" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option>Dimensionnel</option>
                                    <option>Aspect / Esthétique</option>
                                    <option>Matière</option>
                                    <option>Fonctionnel</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Description</label>
                                <textarea id="nc-desc" rows="2" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Action Corrective</label>
                                <input id="nc-action" type="text" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Statut</label>
                                <select id="nc-status" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option>Ouvert</option>
                                    <option>Clôturé</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-all">Créer Rapport</button>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function openEditQualityModal(id) {
            const nc = AppState.nonConformities.find(x => x.id === id);
            if (!nc) return;
            const modalHTML = `
                <div id="quality-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeQualityModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-scale-in">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-black text-slate-900">Modifier NC</h2>
                            <button onclick="closeQualityModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <form onsubmit="event.preventDefault(); updateQuality('${id}');" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">ID Commande</label>
                                <input id="nc-order" type="text" value="${nc.orderId}" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Client</label>
                                <input id="nc-client" type="text" value="${nc.client}" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Type</label>
                                <select id="nc-type" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option ${nc.type === 'Dimensionnel' ? 'selected' : ''}>Dimensionnel</option>
                                    <option ${nc.type === 'Aspect' ? 'selected' : ''}>Aspect / Esthétique</option>
                                    <option ${nc.type === 'Matière' ? 'selected' : ''}>Matière</option>
                                    <option ${nc.type === 'Fonctionnel' ? 'selected' : ''}>Fonctionnel</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Description</label>
                                <textarea id="nc-desc" rows="2" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">${nc.description}</textarea>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Action</label>
                                <input id="nc-action" type="text" value="${nc.action}" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Statut</label>
                                <select id="nc-status" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option ${nc.status === 'Ouvert' ? 'selected' : ''}>Ouvert</option>
                                    <option ${nc.status === 'Clôturé' ? 'selected' : ''}>Clôturé</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-all">Mettre à jour</button>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function closeQualityModal() {
            const el = document.getElementById('quality-modal');
            if (el) el.remove();
        }

        function createQuality() {
            const newNC = {
                id: `NC-${String(Date.now()).slice(-3)}`,
                orderId: document.getElementById('nc-order').value,
                client: document.getElementById('nc-client').value,
                type: document.getElementById('nc-type').value,
                description: document.getElementById('nc-desc').value,
                action: document.getElementById('nc-action').value,
                status: document.getElementById('nc-status').value,
                date: new Date().toISOString().slice(0, 10)
            };
            AppState.nonConformities.push(newNC);
            closeQualityModal();
            render();
        }

        function updateQuality(id) {
            const nc = AppState.nonConformities.find(x => x.id === id);
            if (nc) {
                nc.orderId = document.getElementById('nc-order').value;
                nc.client = document.getElementById('nc-client').value;
                nc.type = document.getElementById('nc-type').value;
                nc.description = document.getElementById('nc-desc').value;
                nc.action = document.getElementById('nc-action').value;
                nc.status = document.getElementById('nc-status').value;
            }
            closeQualityModal();
            render();
        }

        function deleteQuality(id) {
            if (confirm('Supprimer ce rapport ?')) {
                AppState.nonConformities = AppState.nonConformities.filter(x => x.id !== id);
                render();
            }
        }

        // ==================== ADMIN EXPENSES ====================
        function renderAdminExpenses() {
            const totalExpenses = AppState.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h2 class="text-lg font-black text-slate-900">Gestion des Dépenses (${AppState.expenses.length})</h2>
                        <button onclick="openExpenseModal()" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all inline-flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Ajouter une dépense</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm flex items-center justify-between">
                        <div>
                            <div class="text-xs text-slate-500 font-bold">Total des Dépenses</div>
                            <div class="text-2xl font-black text-red-600">${totalExpenses.toLocaleString('fr-FR')} DA</div>
                        </div>
                        <div class="text-xs text-slate-400">Suivi de vos achats (matière, outils, charges...)</div>
                    </div>

                    ${AppState.expenses.length === 0 ? `
                        <div class="bg-white rounded-xl border border-slate-200 p-10 text-center">
                            <i data-lucide="wallet" class="w-12 h-12 text-slate-300 mx-auto mb-3"></i>
                            <p class="text-sm text-slate-500">Aucune dépense enregistrée pour le moment.</p>
                        </div>
                    ` : `
                        <div class="space-y-2">
                            ${AppState.expenses.map(exp => `
                                <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm flex items-start justify-between gap-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-bold text-slate-900 text-sm">${exp.description}</span>
                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">${exp.category}</span>
                                        </div>
                                        <div class="text-xs text-slate-500 flex items-center gap-2">
                                            <i data-lucide="calendar" class="w-3 h-3"></i>
                                            <span>${exp.date}</span>
                                            ${exp.supplier ? `<span>• Fournisseur : <span class="font-semibold">${exp.supplier}</span></span>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end gap-2">
                                        <div class="text-sm font-black text-red-600">${exp.amount.toLocaleString('fr-FR')} DA</div>
                                        <button onclick="deleteExpense('${exp.id}')" class="text-xs text-red-500 hover:text-red-700 flex items-center gap-1">
                                            <i data-lucide="trash-2" class="w-3 h-3"></i> Supprimer
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function openExpenseModal() {
            const modalHTML = `
                <div id="expense-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeExpenseModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-scale-in">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-4 flex items-center justify-between">
                            <h2 class="text-lg font-black text-slate-900">Ajouter une dépense</h2>
                            <button onclick="closeExpenseModal()" class="p-2 hover:bg-slate-100 rounded-full">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <form onsubmit="event.preventDefault(); createExpense();" class="p-4 space-y-3">
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Description</label>
                                <input id="expense-description" type="text" required class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500" placeholder="Ex: Achat Aluminium 6061-T6 (50kg)">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Catégorie</label>
                                <select id="expense-category" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                    <option value="Matières Premières">Matières Premières</option>
                                    <option value="Outils">Outils</option>
                                    <option value="Consommables">Consommables</option>
                                    <option value="Charges">Charges (électricité, loyer...)</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Salaires">Salaires</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Montant (DA)</label>
                                    <input id="expense-amount" type="number" min="0" required class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500" placeholder="30000">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Date</label>
                                    <input id="expense-date" type="date" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500" value="${new Date().toISOString().slice(0, 10)}">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700 uppercase block mb-1">Fournisseur</label>
                                <input id="expense-supplier" type="text" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500" placeholder="Ex: MetalAlgérie">
                            </div>
                            <div class="flex gap-2 pt-2">
                                <button type="button" onclick="closeExpenseModal()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-2 rounded-lg hover:bg-slate-200">Annuler</button>
                                <button type="submit" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-bold py-2 rounded-lg shadow-lg hover:shadow-xl">Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();
        }

        function closeExpenseModal() {
            const modal = document.getElementById('expense-modal');
            if (modal) modal.remove();
        }

        function createExpense() {
            const description = document.getElementById('expense-description').value;
            const category = document.getElementById('expense-category').value;
            const amount = parseFloat(document.getElementById('expense-amount').value || '0');
            const date = document.getElementById('expense-date').value || new Date().toISOString().slice(0, 10);
            const supplier = document.getElementById('expense-supplier').value;

            if (!description || !amount) {
                alert('Veuillez remplir au moins la description et le montant.');
                return;
            }

            const newExpense = {
                id: `EXP-${String(Date.now()).slice(-3)}`,
                description,
                category,
                amount,
                date,
                supplier
            };
            AppState.expenses.unshift(newExpense);
            alert('✅ Dépense ajoutée avec succès !');
            closeExpenseModal();
            render();
        }

        function deleteExpense(expenseId) {
            if (!confirm('Supprimer cette dépense ?')) return;
            const index = AppState.expenses.findIndex(e => e.id === expenseId);
            if (index !== -1) {
                AppState.expenses.splice(index, 1);
                render();
            }
        }

        // ==================== MAIN RENDER ====================
        function render() {
            const app = document.getElementById('app');

            if (AppState.currentView === 'ADMIN') {
                app.innerHTML = renderAdminView();
            } else if (AppState.currentView === 'FACTORY') {
                app.innerHTML = renderFactoryView();
            } else {
                let content = '';

                switch (AppState.currentRoute) {
                    case 'HOME':
                        content = renderHomePage();
                        break;
                    case 'QUOTE':
                        content = renderQuotePage();
                        break;
                    case 'SERVICE_DETAIL':
                        content = renderServiceDetailPage();
                        break;
                    case 'TRAINING':
                        content = renderTrainingPage();
                        break;
                    case 'PARTS':
                        content = renderPartsPage();
                        break;
                    case 'MAINTENANCE':
                        content = renderMaintenancePage();
                        break;
                    case 'NETWORK':
                        content = renderNetworkPage();
                        break;
                    case 'PROFILE':
                        content = renderProfilePage();
                        break;
                    default:
                        content = renderHomePage();
                }

                app.innerHTML = `
                    ${renderHeader()}
                    <main class="flex-1">
                        ${content}
                    </main>
                    ${renderBottomNav()}
                    ${renderMenu()}
                    ${renderSearchModal()}
                    ${renderFloatingChat()}
                    ${renderChatPanel()}
                `;
            }

            // Reinitialize Lucide icons
            lucide.createIcons();

            // Auto-scroll chat to bottom
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Réinitialiser le viewer 3D si un fichier est chargé
            // Cela permet de garder le modèle 3D affiché même après les renders
            if (AppState.uploadState.status === 'complete' &&
                AppState.uploadState.fileData &&
                AppState.uploadState.fileData.buffer) {
                setTimeout(() => {
                    init3DViewer(AppState.uploadState.fileData.buffer, AppState.uploadState.fileData.name);
                }, 50);
            }
        }

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', () => {
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
            }, 1000);

            // Initial render
            render();
        });
    </script>
</body>

</html>